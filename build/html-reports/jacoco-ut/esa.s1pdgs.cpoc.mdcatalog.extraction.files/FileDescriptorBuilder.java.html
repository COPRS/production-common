<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FileDescriptorBuilder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">S1-PDGS Cloud POC - Metadata catalog</a> &gt; <a href="index.source.html" class="el_package">esa.s1pdgs.cpoc.mdcatalog.extraction.files</a> &gt; <span class="el_source">FileDescriptorBuilder.java</span></div><h1>FileDescriptorBuilder.java</h1><pre class="source lang-java linenums">package esa.s1pdgs.cpoc.mdcatalog.extraction.files;

import java.io.File;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import esa.s1pdgs.cpoc.common.EdrsSessionFileType;
import esa.s1pdgs.cpoc.common.FileExtension;
import esa.s1pdgs.cpoc.common.errors.processing.MetadataFilePathException;
import esa.s1pdgs.cpoc.common.errors.processing.MetadataIgnoredFileException;
import esa.s1pdgs.cpoc.common.errors.processing.MetadataIllegalFileExtension;
import esa.s1pdgs.cpoc.mdcatalog.extraction.model.ConfigFileDescriptor;
import esa.s1pdgs.cpoc.mdcatalog.extraction.model.EdrsSessionFileDescriptor;
import esa.s1pdgs.cpoc.mdcatalog.extraction.model.L0OutputFileDescriptor;
import esa.s1pdgs.cpoc.mdcatalog.extraction.model.L1OutputFileDescriptor;

/**
 * Service to build file descriptor
 * 
 * @author Cyrielle Gailliard
 *
 */
public class FileDescriptorBuilder {

	/**
	 * Pattern for files to extract data
	 */
	private final Pattern pattern;

	/**
	 * Local directory for files
	 */
	private final String localDirectory;

	/**
	 * Constructor
	 * 
	 * @param localDirectory
	 * @param pattern
	 */
<span class="fc" id="L41">	public FileDescriptorBuilder(final String localDirectory, final Pattern pattern) {</span>
<span class="fc" id="L42">		this.localDirectory = localDirectory;</span>
<span class="fc" id="L43">		this.pattern = pattern;</span>
<span class="fc" id="L44">	}</span>

	public String toString() {
<span class="nc" id="L47">		return String.format(&quot;localDirectory : %s, pattern : %s&quot;, localDirectory, pattern.toString());</span>
	}

	/**
	 * Build descriptor for configuration files from path file
	 * 
	 * @param file
	 * 
	 * @return the config file descriptor
	 * 
	 * @throws FilePathException
	 *             if we have
	 */
	public ConfigFileDescriptor buildConfigFileDescriptor(File file) throws MetadataFilePathException, MetadataIgnoredFileException {

		// Extract object storage key
<span class="fc" id="L63">		String absolutePath = file.getAbsolutePath();</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">		if (absolutePath.length() &lt;= localDirectory.length()) {</span>
<span class="fc" id="L65">			throw new MetadataFilePathException(absolutePath, &quot;CONFIG&quot;, &quot;File is not in root directory&quot;);</span>
		}
<span class="fc" id="L67">		String relativePath = absolutePath.substring(localDirectory.length());</span>
<span class="fc" id="L68">		relativePath = relativePath.replace(&quot;\\&quot;, &quot;/&quot;);</span>

		// Ignored if directory
<span class="fc bfc" id="L71" title="All 2 branches covered.">		if (file.isDirectory()) {</span>
<span class="fc" id="L72">			throw new MetadataIgnoredFileException(file.getName());</span>
		}

		// Check if key matches the pattern
<span class="fc" id="L76">		ConfigFileDescriptor configFile = null;</span>
<span class="fc" id="L77">		Matcher m = pattern.matcher(relativePath);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">		if (m.matches()) {</span>
			// Extract product name
<span class="fc" id="L80">			String productName = relativePath;</span>
<span class="fc" id="L81">			int indexFirstSeparator = relativePath.indexOf(&quot;/&quot;);</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">			if (indexFirstSeparator != -1) {</span>
<span class="fc" id="L83">				productName = relativePath.substring(0, indexFirstSeparator);</span>
			}
			// Extract filename
<span class="fc" id="L86">			String filename = relativePath;</span>
<span class="fc" id="L87">			int indexLastSeparator = relativePath.lastIndexOf(&quot;/&quot;);</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">			if (indexFirstSeparator != -1) {</span>
<span class="fc" id="L89">				filename = relativePath.substring(indexLastSeparator + 1);</span>
			}
			// Build descriptor
<span class="fc" id="L92">			configFile = new ConfigFileDescriptor();</span>
<span class="fc" id="L93">			configFile.setFilename(filename);</span>
<span class="fc" id="L94">			configFile.setRelativePath(relativePath);</span>
<span class="fc" id="L95">			configFile.setKeyObjectStorage(productName);</span>
<span class="fc" id="L96">			configFile.setProductName(productName);</span>
<span class="fc" id="L97">			configFile.setMissionId(m.group(1));</span>
<span class="fc" id="L98">			configFile.setSatelliteId(m.group(2));</span>
<span class="fc" id="L99">			configFile.setProductClass(m.group(4));</span>
<span class="fc" id="L100">			configFile.setProductType(m.group(5));</span>
<span class="fc" id="L101">			configFile.setExtension(FileExtension.valueOfIgnoreCase(m.group(6).toUpperCase()));</span>

<span class="fc" id="L103">		} else {</span>
<span class="fc" id="L104">			throw new MetadataFilePathException(relativePath, &quot;CONFIG&quot;,</span>
					&quot;File does not match the configuration file pattern&quot;);
		}

<span class="fc" id="L108">		return configFile;</span>
	}

	/**
	 * Function which build the file descriptor for edrs session or raw file
	 * 
	 * @param file
	 * 
	 * @return the edrs file descriptor
	 * 
	 * @throws FilePathException
	 * @throws IgnoredFileException
	 * @throws IllegalFileExtension
	 */
	public EdrsSessionFileDescriptor buildEdrsSessionFileDescriptor(File file)
			throws MetadataFilePathException, MetadataIgnoredFileException, MetadataIllegalFileExtension {
		// Extract relative path
<span class="fc" id="L125">		String absolutePath = file.getAbsolutePath();</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">		if (absolutePath.length() &lt;= localDirectory.length()) {</span>
<span class="fc" id="L127">			throw new MetadataFilePathException(absolutePath, &quot;SESSION&quot;, &quot;File is not in root directory&quot;);</span>
		}
<span class="fc" id="L129">		String relativePath = absolutePath.substring(localDirectory.length());</span>
<span class="fc" id="L130">		relativePath = relativePath.replace(&quot;\\&quot;, &quot;/&quot;);</span>

		// Ignored if directory
<span class="fc bfc" id="L133" title="All 2 branches covered.">		if (file.isDirectory()) {</span>
<span class="fc" id="L134">			throw new MetadataIgnoredFileException(file.getName());</span>
		}

<span class="fc" id="L137">		Matcher m = pattern.matcher(relativePath);</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">		if (m.matches()) {</span>
<span class="fc" id="L139">			EdrsSessionFileDescriptor descriptor = new EdrsSessionFileDescriptor();</span>
<span class="fc" id="L140">			descriptor.setFilename(m.group(9));</span>
<span class="fc" id="L141">			descriptor.setRelativePath(relativePath);</span>
<span class="fc" id="L142">			descriptor.setProductName(m.group(9));</span>
<span class="fc" id="L143">			descriptor.setExtension(FileExtension.valueOfIgnoreCase(m.group(12)));</span>
<span class="fc" id="L144">			descriptor.setProductType(EdrsSessionFileType.valueFromExtension(descriptor.getExtension()));</span>
<span class="fc" id="L145">			descriptor.setMissionId(m.group(1));</span>
<span class="fc" id="L146">			descriptor.setSatelliteId(m.group(2));</span>
<span class="fc" id="L147">			descriptor.setChannel(Integer.parseInt(m.group(7)));</span>
<span class="fc" id="L148">			descriptor.setSessionIdentifier(m.group(4));</span>
<span class="fc" id="L149">			descriptor.setKeyObjectStorage(relativePath);</span>

<span class="fc" id="L151">			return descriptor;</span>
		} else {
<span class="fc" id="L153">			throw new MetadataFilePathException(relativePath, &quot;SESSION&quot;,</span>
					&quot;File does not match the configuration file pattern&quot;);
		}
	}

	public L0OutputFileDescriptor buildL0OutputFileDescriptor(File file)
			throws MetadataFilePathException, MetadataIgnoredFileException {
		// Extract relative path
<span class="fc" id="L161">		String absolutePath = file.getAbsolutePath();</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">		if (absolutePath.length() &lt;= localDirectory.length()) {</span>
<span class="fc" id="L163">			throw new MetadataFilePathException(absolutePath, &quot;L0_PRODUCT&quot;, &quot;File is not in root directory&quot;);</span>
		}
<span class="fc" id="L165">		String relativePath = absolutePath.substring(localDirectory.length());</span>
<span class="fc" id="L166">		relativePath = relativePath.replace(&quot;\\&quot;, &quot;/&quot;);</span>

		// Ignored if directory
<span class="fc bfc" id="L169" title="All 2 branches covered.">		if (file.isDirectory()) {</span>
<span class="fc" id="L170">			throw new MetadataIgnoredFileException(file.getName());</span>
		}
<span class="fc" id="L172">		L0OutputFileDescriptor l0Descriptor = null;</span>
<span class="fc" id="L173">		Matcher m = pattern.matcher(relativePath);</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">		if (m.matches()) {</span>
			// Extract product name
<span class="fc" id="L176">			String productName = relativePath;</span>
<span class="fc" id="L177">			int indexFirstSeparator = relativePath.indexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">			if (indexFirstSeparator != -1) {</span>
<span class="fc" id="L179">				productName = relativePath.substring(0, indexFirstSeparator);</span>
			}
			// Extract filename
<span class="fc" id="L182">			String filename = relativePath;</span>
<span class="fc" id="L183">			int indexLastSeparator = relativePath.lastIndexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">			if (indexFirstSeparator != -1) {</span>
<span class="fc" id="L185">				filename = relativePath.substring(indexLastSeparator + 1);</span>
			}
<span class="fc" id="L187">			l0Descriptor = new L0OutputFileDescriptor();</span>
<span class="fc" id="L188">			l0Descriptor.setProductName(productName);</span>
<span class="fc" id="L189">			l0Descriptor.setRelativePath(relativePath);</span>
<span class="fc" id="L190">			l0Descriptor.setFilename(filename);</span>
<span class="fc" id="L191">			l0Descriptor.setMissionId(m.group(1));</span>
<span class="fc" id="L192">			l0Descriptor.setSatelliteId(m.group(2));</span>
<span class="fc" id="L193">			l0Descriptor.setSwathtype(m.group(3));</span>
<span class="fc" id="L194">			l0Descriptor.setResolution(m.group(5));</span>
<span class="fc" id="L195">			l0Descriptor.setProductClass(m.group(7));</span>
<span class="fc" id="L196">			l0Descriptor.setProductType(m.group(3) + &quot;_&quot; + m.group(4) + m.group(5) + &quot;_&quot; + m.group(6) + m.group(7));</span>
<span class="fc" id="L197">			l0Descriptor.setPolarisation(m.group(8));</span>
<span class="fc" id="L198">			l0Descriptor.setDataTakeId(m.group(12));</span>
<span class="fc" id="L199">			l0Descriptor.setKeyObjectStorage(productName);</span>
<span class="fc" id="L200">			l0Descriptor.setExtension(FileExtension.valueOfIgnoreCase(m.group(13)));</span>

<span class="fc" id="L202">		} else {</span>
<span class="fc" id="L203">			throw new MetadataFilePathException(relativePath, &quot;L0_PRODUCT&quot;,</span>
					&quot;File does not match the configuration file pattern&quot;);
		}

<span class="fc" id="L207">		return l0Descriptor;</span>
	}

	public L1OutputFileDescriptor buildL1OutputFileDescriptor(File file)
			throws MetadataFilePathException, MetadataIgnoredFileException {
		// Extract relative path
<span class="fc" id="L213">		String absolutePath = file.getAbsolutePath();</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">		if (absolutePath.length() &lt;= localDirectory.length()) {</span>
<span class="fc" id="L215">			throw new MetadataFilePathException(absolutePath, &quot;L1_PRODUCT&quot;, &quot;File is not in root directory&quot;);</span>
		}
<span class="fc" id="L217">		String relativePath = absolutePath.substring(localDirectory.length());</span>
<span class="fc" id="L218">		relativePath = relativePath.replace(&quot;\\&quot;, &quot;/&quot;);</span>

		// Ignored if directory
<span class="fc bfc" id="L221" title="All 2 branches covered.">		if (file.isDirectory()) {</span>
<span class="fc" id="L222">			throw new MetadataIgnoredFileException(file.getName());</span>
		}
<span class="fc" id="L224">		L1OutputFileDescriptor l1Descriptor = null;</span>
<span class="fc" id="L225">		Matcher m = pattern.matcher(relativePath);</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">		if (m.matches()) {</span>
			// Extract product name
<span class="fc" id="L228">			String productName = relativePath;</span>
<span class="fc" id="L229">			int indexFirstSeparator = relativePath.indexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">			if (indexFirstSeparator != -1) {</span>
<span class="fc" id="L231">				productName = relativePath.substring(0, indexFirstSeparator);</span>
			}
			// Extract filename
<span class="fc" id="L234">			String filename = relativePath;</span>
<span class="fc" id="L235">			int indexLastSeparator = relativePath.lastIndexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">			if (indexFirstSeparator != -1) {</span>
<span class="fc" id="L237">				filename = relativePath.substring(indexLastSeparator + 1);</span>
			}
<span class="fc" id="L239">			l1Descriptor = new L1OutputFileDescriptor();</span>
<span class="fc" id="L240">			l1Descriptor.setProductName(productName);</span>
<span class="fc" id="L241">			l1Descriptor.setRelativePath(relativePath);</span>
<span class="fc" id="L242">			l1Descriptor.setFilename(filename);</span>
<span class="fc" id="L243">			l1Descriptor.setMissionId(m.group(1) + m.group(2));</span>
			// l1Descriptor.setSatelliteId(m.group(2));
<span class="fc" id="L245">			l1Descriptor.setSwathtype(m.group(3));</span>
<span class="fc" id="L246">			l1Descriptor.setResolution(m.group(5));</span>
<span class="fc" id="L247">			l1Descriptor.setProductClass(m.group(7));</span>
<span class="fc" id="L248">			l1Descriptor.setProductType(m.group(3) + &quot;_&quot; + m.group(4) + m.group(5) + &quot;_&quot; + m.group(6) + m.group(7));</span>
<span class="fc" id="L249">			l1Descriptor.setPolarisation(m.group(8));</span>
<span class="fc" id="L250">			l1Descriptor.setDataTakeId(m.group(12));</span>
<span class="fc" id="L251">			l1Descriptor.setKeyObjectStorage(productName);</span>
<span class="fc" id="L252">			l1Descriptor.setExtension(FileExtension.valueOfIgnoreCase(m.group(13)));</span>

<span class="fc" id="L254">		} else {</span>
<span class="fc" id="L255">			throw new MetadataFilePathException(relativePath, &quot;L1_PRODUCT&quot;,</span>
					&quot;File does not match the configuration file pattern&quot;);
		}
<span class="fc" id="L258">		return l1Descriptor;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>