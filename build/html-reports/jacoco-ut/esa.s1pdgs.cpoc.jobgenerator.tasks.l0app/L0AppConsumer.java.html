<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>L0AppConsumer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Spring Boot Docker For Job Generator App</a> &gt; <a href="index.source.html" class="el_package">esa.s1pdgs.cpoc.jobgenerator.tasks.l0app</a> &gt; <span class="el_source">L0AppConsumer.java</span></div><h1>L0AppConsumer.java</h1><pre class="source lang-java linenums">package esa.s1pdgs.cpoc.jobgenerator.tasks.l0app;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;

import esa.s1pdgs.cpoc.appcatalog.client.job.AbstractAppCatalogJobService;
import esa.s1pdgs.cpoc.appcatalog.common.rest.model.job.AppDataJobDto;
import esa.s1pdgs.cpoc.appcatalog.common.rest.model.job.AppDataJobDtoState;
import esa.s1pdgs.cpoc.appcatalog.common.rest.model.job.AppDataJobFileDto;
import esa.s1pdgs.cpoc.appcatalog.common.rest.model.job.AppDataJobProductDto;
import esa.s1pdgs.cpoc.common.EdrsSessionFileType;
import esa.s1pdgs.cpoc.common.errors.AbstractCodedException;
import esa.s1pdgs.cpoc.common.errors.InvalidFormatProduct;
import esa.s1pdgs.cpoc.common.utils.DateUtils;
import esa.s1pdgs.cpoc.jobgenerator.config.ProcessSettings;
import esa.s1pdgs.cpoc.jobgenerator.model.EdrsSessionFile;
import esa.s1pdgs.cpoc.jobgenerator.service.EdrsSessionFileService;
import esa.s1pdgs.cpoc.jobgenerator.status.AppStatus;
import esa.s1pdgs.cpoc.jobgenerator.tasks.AbstractGenericConsumer;
import esa.s1pdgs.cpoc.jobgenerator.tasks.AbstractJobsDispatcher;
import esa.s1pdgs.cpoc.mqi.client.GenericMqiService;
import esa.s1pdgs.cpoc.mqi.client.StatusService;
import esa.s1pdgs.cpoc.mqi.model.queue.EdrsSessionDto;
import esa.s1pdgs.cpoc.mqi.model.rest.GenericMessageDto;

@Component
@ConditionalOnProperty(name = &quot;process.level&quot;, havingValue = &quot;L0&quot;)
public class L0AppConsumer extends AbstractGenericConsumer&lt;EdrsSessionDto&gt; {
    /**
     * Service for EDRS session file
     */
    private final EdrsSessionFileService edrsService;

    @Autowired
    public L0AppConsumer(
            final AbstractJobsDispatcher&lt;EdrsSessionDto&gt; jobDispatcher,
            final ProcessSettings processSettings,
            @Qualifier(&quot;mqiServiceForEdrsSessions&quot;) final GenericMqiService&lt;EdrsSessionDto&gt; mqiService,
            final EdrsSessionFileService edrsService,
            @Qualifier(&quot;mqiServiceForStatus&quot;) final StatusService mqiStatusService,
            @Qualifier(&quot;appCatalogServiceForEdrsSessions&quot;) final AbstractAppCatalogJobService&lt;EdrsSessionDto&gt; appDataService,
            final AppStatus appStatus) {
<span class="fc" id="L50">        super(jobDispatcher, processSettings, mqiService, mqiStatusService,</span>
                appDataService, appStatus);
<span class="fc" id="L52">        this.edrsService = edrsService;</span>
<span class="fc" id="L53">    }</span>

    @Scheduled(fixedDelayString = &quot;${process.fixed-delay-ms}&quot;, initialDelayString = &quot;${process.initial-delay-ms}&quot;)
    public void consumeMessages() {
        // First, consume message
<span class="fc" id="L58">        GenericMessageDto&lt;EdrsSessionDto&gt; mqiMessage = readMessage();</span>
<span class="pc bpc" id="L59" title="1 of 4 branches missed.">        if (mqiMessage == null || mqiMessage.getBody() == null) {</span>
<span class="fc" id="L60">            LOGGER.trace(&quot;[MONITOR] [step 0] No message received: continue&quot;);</span>
<span class="fc" id="L61">            return;</span>
        }

        // Second process message
<span class="fc" id="L65">        EdrsSessionDto leveldto = mqiMessage.getBody();</span>
<span class="fc" id="L66">        String productName = leveldto.getObjectStorageKey();</span>

<span class="fc bfc" id="L68" title="All 2 branches covered.">        if (leveldto.getProductType() == EdrsSessionFileType.SESSION) {</span>

<span class="fc" id="L70">            int step = 0;</span>
<span class="fc" id="L71">            boolean ackOk = false;</span>
<span class="fc" id="L72">            String errorMessage = &quot;&quot;;</span>
            // Note: the report log of consume and global log is raised during
            // building job to get the session identifier which is the real
            // product name
<span class="fc" id="L76">            appStatus.setProcessing(mqiMessage.getIdentifier());</span>

            try {

                // Create the EdrsSessionFile object from the consumed message
<span class="fc" id="L81">                step = 1;</span>
<span class="fc" id="L82">                LOGGER.info(</span>
                        &quot;[MONITOR] [step {}] [productName {}] Building product&quot;,
<span class="fc" id="L84">                        step, leveldto.getObjectStorageKey());</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">                if (leveldto.getChannelId() != 1</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">                        &amp;&amp; leveldto.getChannelId() != 2) {</span>
<span class="fc" id="L87">                    LOGGER.info(</span>
                            &quot;[REPORT] [MONITOR] [step {}] [s1pdgsTask L0JobGeneration] [subTask Consume] [START] [productName {}] [inputs {}] Starting job generation&quot;,
<span class="fc" id="L89">                            step, productName);</span>
<span class="fc" id="L90">                    throw new InvalidFormatProduct(&quot;Invalid channel identifier &quot;</span>
<span class="fc" id="L91">                            + leveldto.getChannelId());</span>
                }
<span class="fc" id="L93">                AppDataJobDto&lt;EdrsSessionDto&gt; appDataJob = buildJob(mqiMessage);</span>
<span class="fc" id="L94">                productName = appDataJob.getProduct().getProductName();</span>

                // Dispatch
<span class="fc" id="L97">                step++;</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">                if (appDataJob.getMessages().size() == 2) {</span>
<span class="nc" id="L99">                    LOGGER.info(</span>
                            &quot;[MONITOR] [step 2] [productName {}] Dispatching product&quot;,
                            productName);
<span class="nc bnc" id="L102" title="All 2 branches missed.">                    if (appDataJob.getState() == AppDataJobDtoState.WAITING) {</span>
<span class="nc" id="L103">                        appDataJob.setState(AppDataJobDtoState.DISPATCHING);</span>
<span class="nc" id="L104">                        appDataJob = appDataService.patchJob(</span>
<span class="nc" id="L105">                                appDataJob.getIdentifier(), appDataJob, false,</span>
                                false, false);
                    }
<span class="nc" id="L108">                    jobsDispatcher.dispatch(appDataJob);</span>
                }

                // Ack
<span class="fc" id="L112">                step++;</span>
<span class="fc" id="L113">                ackOk = true;</span>

<span class="fc" id="L115">            } catch (AbstractCodedException ace) {</span>
<span class="fc" id="L116">                ackOk = false;</span>
<span class="fc" id="L117">                errorMessage = String.format(</span>
                        &quot;[MONITOR] [step %d] [productName %s] [code %d] %s&quot;,
<span class="fc" id="L119">                        step, productName, ace.getCode().getCode(),</span>
<span class="fc" id="L120">                        ace.getLogMessage());</span>
<span class="fc" id="L121">            }</span>

            // Ack and check if application shall stopped
<span class="fc" id="L124">            ackProcessing(mqiMessage, ackOk, productName, errorMessage);</span>

<span class="fc" id="L126">            step = 0;</span>
<span class="fc" id="L127">            LOGGER.info(&quot;[MONITOR] [step 0] [productName {}] End&quot;, step,</span>
<span class="fc" id="L128">                    leveldto.getObjectStorageKey());</span>

        }

<span class="fc" id="L132">    }</span>

    protected AppDataJobDto&lt;EdrsSessionDto&gt; buildJob(
            GenericMessageDto&lt;EdrsSessionDto&gt; mqiMessage)
            throws AbstractCodedException {
        // Check if a job is already created for message identifier
<span class="fc" id="L138">        List&lt;AppDataJobDto&lt;EdrsSessionDto&gt;&gt; existingJobs = appDataService</span>
<span class="fc" id="L139">                .findByMessagesIdentifier(mqiMessage.getIdentifier());</span>

<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (CollectionUtils.isEmpty(existingJobs)) {</span>
<span class="fc" id="L142">            EdrsSessionFile file = edrsService.createSessionFile(</span>
<span class="fc" id="L143">                    mqiMessage.getBody().getObjectStorageKey());</span>

            // Search if session is already in progress
<span class="fc" id="L146">            List&lt;AppDataJobDto&lt;EdrsSessionDto&gt;&gt; existingJobsForSession =</span>
<span class="fc" id="L147">                    appDataService.findByProductSessionId(file.getSessionId());</span>

<span class="fc bfc" id="L149" title="All 2 branches covered.">            if (CollectionUtils.isEmpty(existingJobsForSession)) {</span>

                // Create the JOB
<span class="fc" id="L152">                AppDataJobDto&lt;EdrsSessionDto&gt; jobDto = new AppDataJobDto&lt;&gt;();</span>
                // General details
<span class="fc" id="L154">                jobDto.setLevel(processSettings.getLevel());</span>
<span class="fc" id="L155">                jobDto.setPod(processSettings.getHostname());</span>
                // Messages
<span class="fc" id="L157">                jobDto.getMessages().add(mqiMessage);</span>
                // Product
<span class="fc" id="L159">                AppDataJobProductDto productDto = new AppDataJobProductDto();</span>
<span class="fc" id="L160">                productDto.setSessionId(file.getSessionId());</span>
<span class="fc" id="L161">                productDto.setMissionId(mqiMessage.getBody().getMissionId());</span>
<span class="fc" id="L162">                productDto.setProductName(file.getSessionId());</span>
<span class="fc" id="L163">                productDto</span>
<span class="fc" id="L164">                        .setSatelliteId(mqiMessage.getBody().getSatelliteId());</span>
<span class="fc" id="L165">                productDto.setStartTime(DateUtils.convertToAnotherFormat(</span>
<span class="fc" id="L166">                        file.getStartTime(), EdrsSessionFile.TIME_FORMATTER,</span>
                        AppDataJobProductDto.TIME_FORMATTER));
<span class="fc" id="L168">                productDto.setStopTime(DateUtils.convertToAnotherFormat(</span>
<span class="fc" id="L169">                        file.getStopTime(), EdrsSessionFile.TIME_FORMATTER,</span>
                        AppDataJobProductDto.TIME_FORMATTER));
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">                if (mqiMessage.getBody().getChannelId() == 1) {</span>
<span class="fc" id="L172">                    productDto.setRaws1(file.getRawNames().stream().map(</span>
<span class="fc" id="L173">                            rawI -&gt; new AppDataJobFileDto(rawI.getFileName()))</span>
<span class="fc" id="L174">                            .collect(Collectors.toList()));</span>
                } else {
<span class="nc" id="L176">                    productDto.setRaws2(file.getRawNames().stream().map(</span>
<span class="nc" id="L177">                            rawI -&gt; new AppDataJobFileDto(rawI.getFileName()))</span>
<span class="nc" id="L178">                            .collect(Collectors.toList()));</span>
                }

<span class="fc" id="L181">                jobDto.setProduct(productDto);</span>

<span class="fc" id="L183">                LOGGER.info(</span>
                        &quot;[REPORT] [MONITOR] [s1pdgsTask L0JobGeneration] [START] [productName {}] Starting job generation&quot;,
<span class="fc" id="L185">                        productDto.getProductName());</span>
<span class="fc" id="L186">                LOGGER.info(</span>
                        &quot;[REPORT] [MONITOR] [s1pdgsTask L0JobGeneration] [subTask Consume] [START] [productName {}] [inputs {}] Starting job generation&quot;,
<span class="fc" id="L188">                        productDto.getProductName(),</span>
<span class="fc" id="L189">                        mqiMessage.getBody().getObjectStorageKey());</span>
<span class="fc" id="L190">                return appDataService.newJob(jobDto);</span>

            } else {

                // Update pod if needed
<span class="fc" id="L195">                boolean update = false;</span>
<span class="fc" id="L196">                boolean updateMessage = false;</span>
<span class="fc" id="L197">                boolean updateProduct = false;</span>
<span class="fc" id="L198">                AppDataJobDto&lt;EdrsSessionDto&gt; jobDto =</span>
<span class="fc" id="L199">                        existingJobsForSession.get(0);</span>
<span class="fc" id="L200">                LOGGER.info(</span>
                        &quot;[REPORT] [MONITOR] [s1pdgsTask L0JobGeneration] [subTask Consume] [START] [productName {}] [inputs {}] Starting job generation&quot;,
<span class="fc" id="L202">                        jobDto.getProduct().getProductName(),</span>
<span class="fc" id="L203">                        mqiMessage.getBody().getObjectStorageKey());</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">                if (!jobDto.getPod().equals(processSettings.getHostname())) {</span>
<span class="fc" id="L205">                    jobDto.setPod(processSettings.getHostname());</span>
<span class="fc" id="L206">                    update = true;</span>
                }
                // Updates messages if needed
<span class="fc bfc" id="L209" title="All 2 branches covered.">                if (jobDto.getMessages().size() == 1 &amp;&amp; jobDto.getMessages()</span>
<span class="fc" id="L210">                        .get(0).getBody().getChannelId() != mqiMessage.getBody()</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">                                .getChannelId()) {</span>
<span class="fc" id="L212">                    jobDto.getMessages().add(mqiMessage);</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">                    if (mqiMessage.getBody().getChannelId() == 1) {</span>
<span class="fc" id="L214">                        jobDto.getProduct()</span>
<span class="fc" id="L215">                                .setRaws1(file.getRawNames().stream()</span>
<span class="fc" id="L216">                                        .map(rawI -&gt; new AppDataJobFileDto(</span>
<span class="fc" id="L217">                                                rawI.getFileName()))</span>
<span class="fc" id="L218">                                        .collect(Collectors.toList()));</span>
                    } else {
<span class="nc" id="L220">                        jobDto.getProduct()</span>
<span class="nc" id="L221">                                .setRaws2(file.getRawNames().stream()</span>
<span class="nc" id="L222">                                        .map(rawI -&gt; new AppDataJobFileDto(</span>
<span class="nc" id="L223">                                                rawI.getFileName()))</span>
<span class="nc" id="L224">                                        .collect(Collectors.toList()));</span>
                    }
<span class="fc" id="L226">                    update = true;</span>
<span class="fc" id="L227">                    updateMessage = true;</span>
<span class="fc" id="L228">                    updateProduct = true;</span>
                }
                // Update
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">                if (update) {</span>
<span class="fc" id="L232">                    jobDto = appDataService.patchJob(jobDto.getIdentifier(),</span>
                            jobDto, updateMessage, updateProduct, false);
                }
                // Return object
<span class="fc" id="L236">                return jobDto;</span>

            }

        } else {
            // Update pod if needed
<span class="fc" id="L242">            boolean update = false;</span>
<span class="fc" id="L243">            boolean updateMessage = false;</span>
<span class="fc" id="L244">            boolean updateProduct = false;</span>
<span class="fc" id="L245">            AppDataJobDto&lt;EdrsSessionDto&gt; jobDto = existingJobs.get(0);</span>
<span class="fc" id="L246">            LOGGER.info(</span>
                    &quot;[REPORT] [MONITOR] [s1pdgsTask L0JobGeneration] [subTask Consume] [START] [productName {}] [inputs {}] Starting job generation&quot;,
<span class="fc" id="L248">                    jobDto.getProduct().getProductName(),</span>
<span class="fc" id="L249">                    mqiMessage.getBody().getObjectStorageKey());</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">            if (!jobDto.getPod().equals(processSettings.getHostname())) {</span>
<span class="fc" id="L251">                jobDto.setPod(processSettings.getHostname());</span>
<span class="fc" id="L252">                update = true;</span>
            }
            // Update
<span class="fc bfc" id="L255" title="All 2 branches covered.">            if (update) {</span>
<span class="fc" id="L256">                jobDto = appDataService.patchJob(jobDto.getIdentifier(), jobDto,</span>
                        updateMessage, updateProduct, false);
            }
            // Retrun object
<span class="fc" id="L260">            return jobDto;</span>
        }

    }

    @Override
    protected String getTaskForFunctionalLog() {
<span class="fc" id="L267">        return &quot;L0JobGeneration&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>