<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageConsumptionController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MQI server</a> &gt; <a href="index.source.html" class="el_package">esa.s1pdgs.cpoc.mqi.server.consumption</a> &gt; <span class="el_source">MessageConsumptionController.java</span></div><h1>MessageConsumptionController.java</h1><pre class="source lang-java linenums">package esa.s1pdgs.cpoc.mqi.server.consumption;

import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.PostConstruct;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;
import org.springframework.util.CollectionUtils;

import esa.s1pdgs.cpoc.appcatalog.client.mqi.GenericAppCatalogMqiService;
import esa.s1pdgs.cpoc.appcatalog.rest.MqiGenericMessageDto;
import esa.s1pdgs.cpoc.appcatalog.rest.MqiLightMessageDto;
import esa.s1pdgs.cpoc.appcatalog.rest.MqiSendMessageDto;
import esa.s1pdgs.cpoc.appcatalog.rest.MqiStateMessageEnum;
import esa.s1pdgs.cpoc.common.ProductCategory;
import esa.s1pdgs.cpoc.common.ResumeDetails;
import esa.s1pdgs.cpoc.common.errors.AbstractCodedException;
import esa.s1pdgs.cpoc.common.errors.mqi.MqiCategoryNotAvailable;
import esa.s1pdgs.cpoc.mqi.model.queue.AuxiliaryFileDto;
import esa.s1pdgs.cpoc.mqi.model.queue.EdrsSessionDto;
import esa.s1pdgs.cpoc.mqi.model.queue.LevelJobDto;
import esa.s1pdgs.cpoc.mqi.model.queue.LevelProductDto;
import esa.s1pdgs.cpoc.mqi.model.queue.LevelReportDto;
import esa.s1pdgs.cpoc.mqi.model.rest.Ack;
import esa.s1pdgs.cpoc.mqi.model.rest.GenericMessageDto;
import esa.s1pdgs.cpoc.mqi.server.ApplicationProperties;
import esa.s1pdgs.cpoc.mqi.server.ApplicationProperties.ProductCategoryConsumptionProperties;
import esa.s1pdgs.cpoc.mqi.server.ApplicationProperties.ProductCategoryProperties;
import esa.s1pdgs.cpoc.mqi.server.KafkaProperties;
import esa.s1pdgs.cpoc.mqi.server.consumption.kafka.consumer.GenericConsumer;
import esa.s1pdgs.cpoc.mqi.server.persistence.OtherApplicationService;
import esa.s1pdgs.cpoc.mqi.server.status.AppStatus;

/**
 * Manager of consumers
 * 
 * @author Viveris Technologies
 */
@Controller
public class MessageConsumptionController {

    /**
     * Logger
     */
<span class="fc" id="L52">    protected static final Logger LOGGER =</span>
<span class="fc" id="L53">            LogManager.getLogger(MessageConsumptionController.class);</span>

    /**
     * List of consumers
     */
    protected final Map&lt;ProductCategory, Map&lt;String, GenericConsumer&lt;?&gt;&gt;&gt; consumers;

    /**
     * Application properties
     */
    private final ApplicationProperties appProperties;

    /**
     * Kafka properties
     */
    private final KafkaProperties kafkaProperties;

    /**
     * Services
     */
    private final Map&lt;ProductCategory, GenericAppCatalogMqiService&lt;?&gt;&gt; persistServices;

    /**
     * Service for AUXILIARY_FILES
     */
    private final GenericAppCatalogMqiService&lt;AuxiliaryFileDto&gt; persistAuxiliaryFilesService;

    /**
     * Service for AUXILIARY_FILES
     */
    private final GenericAppCatalogMqiService&lt;EdrsSessionDto&gt; persistEdrsSessionsService;

    /**
     * Service for AUXILIARY_FILES
     */
    private final GenericAppCatalogMqiService&lt;LevelJobDto&gt; persistLevelJobsService;

    /**
     * Service for AUXILIARY_FILES
     */
    private final GenericAppCatalogMqiService&lt;LevelProductDto&gt; persistLevelProductsService;

    /**
     * Service for AUXILIARY_FILES
     */
    private final GenericAppCatalogMqiService&lt;LevelReportDto&gt; persistLevelReportsService;

    /**
     * Service for checking if a message is processing or not by another
     */
    private final OtherApplicationService otherAppService;

    /**
     * Application status
     */
    private final AppStatus appStatus;

    /**
     * Constructor
     * 
     * @param appProperties
     * @param kafkaProperties
     */
    @Autowired
    public MessageConsumptionController(
            final ApplicationProperties appProperties,
            final KafkaProperties kafkaProperties,
            @Qualifier(&quot;persistenceServiceForAuxiliaryFiles&quot;) final GenericAppCatalogMqiService&lt;AuxiliaryFileDto&gt; persistAuxiliaryFilesService,
            @Qualifier(&quot;persistenceServiceForEdrsSessions&quot;) final GenericAppCatalogMqiService&lt;EdrsSessionDto&gt; persistEdrsSessionsService,
            @Qualifier(&quot;persistenceServiceForLevelJobs&quot;) final GenericAppCatalogMqiService&lt;LevelJobDto&gt; persistLevelJobsService,
            @Qualifier(&quot;persistenceServiceForLevelProducts&quot;) final GenericAppCatalogMqiService&lt;LevelProductDto&gt; persistLevelProductsService,
            @Qualifier(&quot;persistenceServiceForLevelReports&quot;) final GenericAppCatalogMqiService&lt;LevelReportDto&gt; persistLevelReportsService,
            final OtherApplicationService otherAppService,
<span class="fc" id="L126">            final AppStatus appStatus) {</span>
<span class="fc" id="L127">        this.consumers = new HashMap&lt;&gt;();</span>
<span class="fc" id="L128">        this.appProperties = appProperties;</span>
<span class="fc" id="L129">        this.kafkaProperties = kafkaProperties;</span>
<span class="fc" id="L130">        this.otherAppService = otherAppService;</span>
<span class="fc" id="L131">        this.persistServices = new HashMap&lt;&gt;();</span>
<span class="fc" id="L132">        this.persistAuxiliaryFilesService = persistAuxiliaryFilesService;</span>
<span class="fc" id="L133">        this.persistEdrsSessionsService = persistEdrsSessionsService;</span>
<span class="fc" id="L134">        this.persistLevelJobsService = persistLevelJobsService;</span>
<span class="fc" id="L135">        this.persistLevelProductsService = persistLevelProductsService;</span>
<span class="fc" id="L136">        this.persistLevelReportsService = persistLevelReportsService;</span>
<span class="fc" id="L137">        this.persistServices.put(ProductCategory.AUXILIARY_FILES,</span>
                this.persistAuxiliaryFilesService);
<span class="fc" id="L139">        this.persistServices.put(ProductCategory.EDRS_SESSIONS,</span>
                this.persistEdrsSessionsService);
<span class="fc" id="L141">        this.persistServices.put(ProductCategory.LEVEL_JOBS,</span>
                this.persistLevelJobsService);
<span class="fc" id="L143">        this.persistServices.put(ProductCategory.LEVEL_PRODUCTS,</span>
                this.persistLevelProductsService);
<span class="fc" id="L145">        this.persistServices.put(ProductCategory.LEVEL_REPORTS,</span>
                this.persistLevelReportsService);
<span class="fc" id="L147">        this.appStatus = appStatus;</span>
<span class="fc" id="L148">    }</span>

    /**
     * Start consumers according the configuration
     */
    @PostConstruct
    public void startConsumers() {

        // Init the list of consumers
<span class="fc bfc" id="L157" title="All 2 branches covered.">        for (ProductCategory cat : appProperties.getProductCategories()</span>
<span class="fc" id="L158">                .keySet()) {</span>
<span class="fc" id="L159">            ProductCategoryProperties catProp =</span>
<span class="fc" id="L160">                    appProperties.getProductCategories().get(cat);</span>
<span class="fc" id="L161">            ProductCategoryConsumptionProperties prop =</span>
<span class="fc" id="L162">                    catProp.getConsumption();</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">            if (prop.isEnable()) {</span>
<span class="fc" id="L164">                LOGGER.info(</span>
                        &quot;Creating consumers on topics {} with for category {}&quot;,
<span class="fc" id="L166">                        prop.getTopicsWithPriority(), cat);</span>
<span class="fc" id="L167">                Map&lt;String, GenericConsumer&lt;?&gt;&gt; catConsumers = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">                for (String topic : prop.getTopicsWithPriority().keySet()) {</span>
<span class="pc bpc" id="L169" title="1 of 6 branches missed.">                    switch (cat) {</span>
                        case AUXILIARY_FILES:
<span class="fc" id="L171">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;AuxiliaryFileDto&gt;(
                                            kafkaProperties,
                                            persistAuxiliaryFilesService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L176">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            AuxiliaryFileDto.class));
<span class="fc" id="L178">                            break;</span>
                        case EDRS_SESSIONS:
<span class="fc" id="L180">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;EdrsSessionDto&gt;(
                                            kafkaProperties,
                                            persistEdrsSessionsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L185">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            EdrsSessionDto.class));
<span class="fc" id="L187">                            break;</span>
                        case LEVEL_JOBS:
<span class="fc" id="L189">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;LevelJobDto&gt;(
                                            kafkaProperties,
                                            persistLevelJobsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L194">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            LevelJobDto.class));
<span class="fc" id="L196">                            break;</span>
                        case LEVEL_PRODUCTS:
<span class="fc" id="L198">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;LevelProductDto&gt;(
                                            kafkaProperties,
                                            persistLevelProductsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L203">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            LevelProductDto.class));
<span class="fc" id="L205">                            break;</span>
                        case LEVEL_REPORTS:
<span class="fc" id="L207">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;LevelReportDto&gt;(
                                            kafkaProperties,
                                            persistLevelReportsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L212">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            LevelReportDto.class));
                            break;
                    }
<span class="fc" id="L216">                }</span>
<span class="fc" id="L217">                consumers.put(cat, catConsumers);</span>
            }
<span class="fc" id="L219">        }</span>
        // Start the consumers
<span class="fc bfc" id="L221" title="All 2 branches covered.">        for (Map&lt;String, GenericConsumer&lt;?&gt;&gt; catConsumers : consumers</span>
<span class="fc" id="L222">                .values()) {</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">            for (GenericConsumer&lt;?&gt; consumer : catConsumers.values()) {</span>
<span class="fc" id="L224">                LOGGER.info(&quot;Starting consumer on topic {}&quot;,</span>
<span class="fc" id="L225">                        consumer.getTopic());</span>
<span class="fc" id="L226">                consumer.start();</span>
<span class="fc" id="L227">            }</span>
<span class="fc" id="L228">        }</span>
<span class="fc" id="L229">    }</span>

    /**
     * Get the next message for a given category
     * 
     * @param category
     * @return
     * @throws AbstractCodedException
     */
    public GenericMessageDto&lt;?&gt; nextMessage(final ProductCategory category)
            throws AbstractCodedException {
<span class="fc" id="L240">        GenericMessageDto&lt;?&gt; message = null;</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">        if (consumers.containsKey(category)) {</span>
<span class="fc bfc" id="L242" title="All 5 branches covered.">            switch (category) {</span>
                case EDRS_SESSIONS:
<span class="fc" id="L244">                    message = nextEdrsSessionsMessage();</span>
<span class="fc" id="L245">                    break;</span>
                case LEVEL_JOBS:
<span class="fc" id="L247">                    message = nextLevelJobsMessage();</span>
<span class="fc" id="L248">                    break;</span>
                case LEVEL_PRODUCTS:
<span class="fc" id="L250">                    message = nextLevelProductsMessage();</span>
<span class="fc" id="L251">                    break;</span>
                case LEVEL_REPORTS:
<span class="fc" id="L253">                    message = nextLevelReportsMessage();</span>
<span class="fc" id="L254">                    break;</span>
                default:
<span class="fc" id="L256">                    message = nextAuxiliaryFilesMessage();</span>
                    break;
            }
            // if no message and consumer is pause =&gt; resume it
<span class="fc bfc" id="L260" title="All 2 branches covered.">            if (message == null) {</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">                for(GenericConsumer&lt;?&gt; consumer: consumers.get(category).values()) {</span>
<span class="fc" id="L262">                    consumer.resume();</span>
<span class="fc" id="L263">                }</span>
            }
        } else {
<span class="fc" id="L266">            throw new MqiCategoryNotAvailable(category, &quot;consumer&quot;);</span>
        }
<span class="fc" id="L268">        return message;</span>
    }

    /**
     * Get the next message for auxiliary files
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;AuxiliaryFileDto&gt; nextAuxiliaryFilesMessage()
            throws AbstractCodedException {
<span class="fc" id="L280">        List&lt;MqiGenericMessageDto&lt;AuxiliaryFileDto&gt;&gt; messages =</span>
<span class="fc" id="L281">                persistAuxiliaryFilesService.next(appProperties.getHostname());</span>
<span class="fc" id="L282">        MqiGenericMessageDto&lt;AuxiliaryFileDto&gt; result = null;</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L284">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;AuxiliaryFileDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;AuxiliaryFileDto&gt; o1,
                        MqiGenericMessageDto&lt;AuxiliaryFileDto&gt; o2) {
<span class="fc" id="L288">                    if(consumers.get(ProductCategory.AUXILIARY_FILES).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.AUXILIARY_FILES).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L290">                        return -1;</span>
<span class="fc" id="L291">                    } else if(consumers.get(ProductCategory.AUXILIARY_FILES).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.AUXILIARY_FILES).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L294">                            return 1;</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L296">                            return -1;</span>
                        } else {
<span class="fc" id="L298">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L301">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;AuxiliaryFileDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">                if (send(persistAuxiliaryFilesService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L308">                    result = tmpMessage;</span>
<span class="fc" id="L309">                    break;</span>
                }
<span class="fc" id="L311">            }</span>
        }
<span class="fc" id="L313">        return (GenericMessageDto&lt;AuxiliaryFileDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for edrs sessions
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;EdrsSessionDto&gt; nextEdrsSessionsMessage()
            throws AbstractCodedException {
<span class="fc" id="L325">        List&lt;MqiGenericMessageDto&lt;EdrsSessionDto&gt;&gt; messages =</span>
<span class="fc" id="L326">                persistEdrsSessionsService.next(appProperties.getHostname());</span>
<span class="fc" id="L327">        MqiGenericMessageDto&lt;EdrsSessionDto&gt; result = null;</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L329">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;EdrsSessionDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;EdrsSessionDto&gt; o1,
                        MqiGenericMessageDto&lt;EdrsSessionDto&gt; o2) {
<span class="fc" id="L333">                    if(consumers.get(ProductCategory.EDRS_SESSIONS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.EDRS_SESSIONS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L335">                        return -1;</span>
<span class="fc" id="L336">                    } else if(consumers.get(ProductCategory.EDRS_SESSIONS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L337" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.EDRS_SESSIONS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L339">                            return 1;</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L341">                            return -1;</span>
                        } else {
<span class="fc" id="L343">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L346">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;EdrsSessionDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">                if (send(persistEdrsSessionsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L353">                    result = tmpMessage;</span>
<span class="fc" id="L354">                    break;</span>
                }
<span class="fc" id="L356">            }</span>
        }
<span class="fc" id="L358">        return (GenericMessageDto&lt;EdrsSessionDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for product jobs
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;LevelJobDto&gt; nextLevelJobsMessage()
            throws AbstractCodedException {
<span class="fc" id="L370">        List&lt;MqiGenericMessageDto&lt;LevelJobDto&gt;&gt; messages =</span>
<span class="fc" id="L371">                persistLevelJobsService.next(appProperties.getHostname());</span>
<span class="fc" id="L372">        MqiGenericMessageDto&lt;LevelJobDto&gt; result = null;</span>
<span class="fc bfc" id="L373" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L374">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;LevelJobDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;LevelJobDto&gt; o1,
                        MqiGenericMessageDto&lt;LevelJobDto&gt; o2) {
<span class="fc" id="L378">                    if(consumers.get(ProductCategory.LEVEL_JOBS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.LEVEL_JOBS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L380">                        return -1;</span>
<span class="fc" id="L381">                    } else if(consumers.get(ProductCategory.LEVEL_JOBS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.LEVEL_JOBS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L383" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L384">                            return 1;</span>
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L386">                            return -1;</span>
                        } else {
<span class="fc" id="L388">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L391">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;LevelJobDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">                if (send(persistLevelJobsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L398">                    result = tmpMessage;</span>
<span class="fc" id="L399">                    break;</span>
                }
<span class="fc" id="L401">            }</span>
        }
<span class="fc" id="L403">        return (GenericMessageDto&lt;LevelJobDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for level products
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;LevelProductDto&gt; nextLevelProductsMessage()
            throws AbstractCodedException {
<span class="fc" id="L415">        List&lt;MqiGenericMessageDto&lt;LevelProductDto&gt;&gt; messages =</span>
<span class="fc" id="L416">                persistLevelProductsService.next(appProperties.getHostname());</span>
<span class="fc" id="L417">        MqiGenericMessageDto&lt;LevelProductDto&gt; result = null;</span>
<span class="fc bfc" id="L418" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L419">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;LevelProductDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;LevelProductDto&gt; o1,
                        MqiGenericMessageDto&lt;LevelProductDto&gt; o2) {
<span class="fc" id="L423">                    if(consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L425">                        return -1;</span>
<span class="fc" id="L426">                    } else if(consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L429">                            return 1;</span>
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L431">                            return -1;</span>
                        } else {
<span class="fc" id="L433">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L436">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;LevelProductDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L441" title="All 2 branches covered.">                if (send(persistLevelProductsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L443">                    result = tmpMessage;</span>
<span class="fc" id="L444">                    break;</span>
                }
<span class="fc" id="L446">            }</span>
        }
<span class="fc" id="L448">        return (GenericMessageDto&lt;LevelProductDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for level reports
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;LevelReportDto&gt; nextLevelReportsMessage()
            throws AbstractCodedException {
<span class="fc" id="L460">        List&lt;MqiGenericMessageDto&lt;LevelReportDto&gt;&gt; messages =</span>
<span class="fc" id="L461">                persistLevelReportsService.next(appProperties.getHostname());</span>
<span class="fc" id="L462">        MqiGenericMessageDto&lt;LevelReportDto&gt; result = null;</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L464">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;LevelReportDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;LevelReportDto&gt; o1,
                        MqiGenericMessageDto&lt;LevelReportDto&gt; o2) {
<span class="fc" id="L468">                    if(consumers.get(ProductCategory.LEVEL_REPORTS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.LEVEL_REPORTS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L470">                        return -1;</span>
<span class="fc" id="L471">                    } else if(consumers.get(ProductCategory.LEVEL_REPORTS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L472" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.LEVEL_REPORTS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L474">                            return 1;</span>
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L476">                            return -1;</span>
                        } else {
<span class="fc" id="L478">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L481">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L485" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;LevelReportDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L486" title="All 2 branches covered.">                if (send(persistLevelReportsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L488">                    result = tmpMessage;</span>
<span class="fc" id="L489">                    break;</span>
                }
<span class="fc" id="L491">            }</span>
        }
<span class="fc" id="L493">        return (GenericMessageDto&lt;LevelReportDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * @param service
     * @param messageId
     * @param force
     * @return
     * @throws AbstractCodedException
     */
    protected boolean send(final GenericAppCatalogMqiService&lt;?&gt; service,
            final MqiLightMessageDto message) throws AbstractCodedException {
<span class="fc" id="L505">        boolean ret = false;</span>
<span class="fc bfc" id="L506" title="All 2 branches covered.">        if (message.getState() == MqiStateMessageEnum.SEND) {</span>
<span class="fc bfc" id="L507" title="All 2 branches covered.">            if (isSameSendingPod(message.getSendingPod())) {</span>

<span class="fc" id="L509">                ret = service.send(message.getIdentifier(),</span>
<span class="fc" id="L510">                        new MqiSendMessageDto(appProperties.getHostname(),</span>
                                false));
            } else {
<span class="fc" id="L513">                boolean isProcessing = false;</span>
                try {
<span class="fc" id="L515">                    isProcessing = otherAppService.isProcessing(</span>
<span class="fc" id="L516">                            message.getSendingPod(), service.getCategory(),</span>
<span class="fc" id="L517">                            message.getIdentifier());</span>
<span class="fc" id="L518">                } catch (AbstractCodedException ace) {</span>
<span class="fc" id="L519">                    isProcessing = false;</span>
<span class="fc" id="L520">                    LOGGER.warn(</span>
                            &quot;{} No response from the other application, consider it as dead&quot;,
<span class="fc" id="L522">                            ace.getLogMessage());</span>
<span class="fc" id="L523">                }</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">                if (!isProcessing) {</span>
<span class="fc" id="L525">                    ret = service.send(message.getIdentifier(),</span>
<span class="fc" id="L526">                            new MqiSendMessageDto(appProperties.getHostname(),</span>
                                    true));
                } else {
<span class="fc" id="L529">                    ret = false;</span>
                }
<span class="fc" id="L531">            }</span>
        } else {
            // We return this message after persisting it as sending
<span class="fc" id="L534">            ret = service.send(message.getIdentifier(),</span>
<span class="fc" id="L535">                    new MqiSendMessageDto(appProperties.getHostname(), false));</span>
        }

<span class="fc" id="L538">        return ret;</span>
    }

    /**
     * @param sendingPod
     * @return
     */
    protected boolean isSameSendingPod(final String sendingPod) {
<span class="fc" id="L546">        return appProperties.getHostname().equals(sendingPod);</span>
    }

    /**
     * Convert an app catalog rest object into mqi rest object from next API
     * 
     * @param object
     * @return
     */
    private GenericMessageDto&lt;?&gt; convertToRestDto(
            final MqiGenericMessageDto&lt;?&gt; object) {
<span class="fc bfc" id="L557" title="All 2 branches covered.">        if (object == null) {</span>
<span class="fc" id="L558">            return null;</span>
        }
<span class="fc" id="L560">        return new GenericMessageDto&lt;&gt;(object.getIdentifier(),</span>
<span class="fc" id="L561">                object.getTopic(), object.getDto());</span>
    }

    /**
     * Acknowledge a message
     * 
     * @param identifier
     * @param ack
     * @param message
     * @throws AbstractCodedException
     */
    public ResumeDetails ackMessage(final ProductCategory category,
            final long identifier, final Ack ack, final boolean stop)
            throws AbstractCodedException {
<span class="fc" id="L575">        ResumeDetails ret = null;</span>
<span class="fc" id="L576">        int nbReadingMsg = 0;</span>
<span class="fc" id="L577">        MqiGenericMessageDto&lt;?&gt; message = null;</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">        if (consumers.containsKey(category)) {</span>
            try {
                // Ack message
<span class="fc" id="L581">                persistServices.get(category).ack(identifier, ack);</span>
                // Get resume details and topic
<span class="fc" id="L583">                message = persistServices.get(category).get(identifier);</span>
                // Get remaining message read
<span class="fc" id="L585">                nbReadingMsg = persistServices.get(category)</span>
<span class="fc" id="L586">                        .getNbReadingMessages(message.getTopic(),</span>
<span class="fc" id="L587">                                appProperties.getHostname());</span>
<span class="fc" id="L588">                ret = new ResumeDetails(message.getTopic(), message.getDto());</span>
            } finally {
                // Resume consumer of concerned topic
<span class="pc bpc" id="L591" title="2 of 6 branches missed.">                if (!stop &amp;&amp; nbReadingMsg &lt;= 0 &amp;&amp; message != null) {</span>
                    // Resume consumer
<span class="fc" id="L593">                    if (consumers.get(category)</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">                            .containsKey(message.getTopic())) {</span>
<span class="fc" id="L595">                        consumers.get(category).get(message.getTopic())</span>
<span class="fc" id="L596">                                .resume();</span>
                    } else {
<span class="fc" id="L598">                        LOGGER.warn(</span>
                                &quot;[category {}] [messageCannot resume consumer for this topic because does not exist: {}&quot;,
                                category, message);
                    }
                }
            }
        } else {
<span class="fc" id="L605">            throw new MqiCategoryNotAvailable(category, &quot;consumer&quot;);</span>
        }
<span class="fc" id="L607">        return ret;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>