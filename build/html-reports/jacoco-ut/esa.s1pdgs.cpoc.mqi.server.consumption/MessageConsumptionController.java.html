<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageConsumptionController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">S1-PDGS Cloud POC - Message queue interface server</a> &gt; <a href="index.source.html" class="el_package">esa.s1pdgs.cpoc.mqi.server.consumption</a> &gt; <span class="el_source">MessageConsumptionController.java</span></div><h1>MessageConsumptionController.java</h1><pre class="source lang-java linenums">package esa.s1pdgs.cpoc.mqi.server.consumption;

import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.PostConstruct;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;
import org.springframework.util.CollectionUtils;

import esa.s1pdgs.cpoc.appcatalog.client.mqi.GenericAppCatalogMqiService;
import esa.s1pdgs.cpoc.appcatalog.rest.MqiGenericMessageDto;
import esa.s1pdgs.cpoc.appcatalog.rest.MqiLightMessageDto;
import esa.s1pdgs.cpoc.appcatalog.rest.MqiSendMessageDto;
import esa.s1pdgs.cpoc.appcatalog.rest.MqiStateMessageEnum;
import esa.s1pdgs.cpoc.common.ProductCategory;
import esa.s1pdgs.cpoc.common.ResumeDetails;
import esa.s1pdgs.cpoc.common.errors.AbstractCodedException;
import esa.s1pdgs.cpoc.common.errors.mqi.MqiCategoryNotAvailable;
import esa.s1pdgs.cpoc.mqi.model.queue.AuxiliaryFileDto;
import esa.s1pdgs.cpoc.mqi.model.queue.EdrsSessionDto;
import esa.s1pdgs.cpoc.mqi.model.queue.LevelJobDto;
import esa.s1pdgs.cpoc.mqi.model.queue.LevelProductDto;
import esa.s1pdgs.cpoc.mqi.model.queue.LevelReportDto;
import esa.s1pdgs.cpoc.mqi.model.queue.LevelSegmentDto;
import esa.s1pdgs.cpoc.mqi.model.rest.Ack;
import esa.s1pdgs.cpoc.mqi.model.rest.GenericMessageDto;
import esa.s1pdgs.cpoc.mqi.server.ApplicationProperties;
import esa.s1pdgs.cpoc.mqi.server.ApplicationProperties.ProductCategoryConsumptionProperties;
import esa.s1pdgs.cpoc.mqi.server.ApplicationProperties.ProductCategoryProperties;
import esa.s1pdgs.cpoc.mqi.server.KafkaProperties;
import esa.s1pdgs.cpoc.mqi.server.consumption.kafka.consumer.GenericConsumer;
import esa.s1pdgs.cpoc.mqi.server.persistence.OtherApplicationService;
import esa.s1pdgs.cpoc.mqi.server.status.AppStatus;

/**
 * Manager of consumers
 * 
 * @author Viveris Technologies
 */
@Controller
public class MessageConsumptionController {

    /**
     * Logger
     */
<span class="fc" id="L53">    protected static final Logger LOGGER =</span>
<span class="fc" id="L54">            LogManager.getLogger(MessageConsumptionController.class);</span>

    /**
     * List of consumers
     */
    protected final Map&lt;ProductCategory, Map&lt;String, GenericConsumer&lt;?&gt;&gt;&gt; consumers;

    /**
     * Application properties
     */
    private final ApplicationProperties appProperties;

    /**
     * Kafka properties
     */
    private final KafkaProperties kafkaProperties;

    /**
     * Services
     */
    private final Map&lt;ProductCategory, GenericAppCatalogMqiService&lt;?&gt;&gt; persistServices;

    /**
     * Service for AUXILIARY_FILES
     */
    private final GenericAppCatalogMqiService&lt;AuxiliaryFileDto&gt; persistAuxiliaryFilesService;

    /**
     * Service for EDRS_SESSIONS
     */
    private final GenericAppCatalogMqiService&lt;EdrsSessionDto&gt; persistEdrsSessionsService;

    /**
     * Service for LEVEL_JOBS
     */
    private final GenericAppCatalogMqiService&lt;LevelJobDto&gt; persistLevelJobsService;

    /**
     * Service for LEVEL_PRODUCTS
     */
    private final GenericAppCatalogMqiService&lt;LevelProductDto&gt; persistLevelProductsService;

    /**
     * Service for LEVEL_REPORTS
     */
    private final GenericAppCatalogMqiService&lt;LevelReportDto&gt; persistLevelReportsService;

    /**
     * Service for LEVEL_SEGMENTS
     */
    private final GenericAppCatalogMqiService&lt;LevelSegmentDto&gt; persistLevelSegmentsService;

    /**
     * Service for checking if a message is processing or not by another
     */
    private final OtherApplicationService otherAppService;

    /**
     * Application status
     */
    private final AppStatus appStatus;

    /**
     * Constructor
     * 
     * @param appProperties
     * @param kafkaProperties
     */
    @Autowired
    public MessageConsumptionController(
            final ApplicationProperties appProperties,
            final KafkaProperties kafkaProperties,
            @Qualifier(&quot;persistenceServiceForAuxiliaryFiles&quot;) final GenericAppCatalogMqiService&lt;AuxiliaryFileDto&gt; persistAuxiliaryFilesService,
            @Qualifier(&quot;persistenceServiceForEdrsSessions&quot;) final GenericAppCatalogMqiService&lt;EdrsSessionDto&gt; persistEdrsSessionsService,
            @Qualifier(&quot;persistenceServiceForLevelJobs&quot;) final GenericAppCatalogMqiService&lt;LevelJobDto&gt; persistLevelJobsService,
            @Qualifier(&quot;persistenceServiceForLevelProducts&quot;) final GenericAppCatalogMqiService&lt;LevelProductDto&gt; persistLevelProductsService,
            @Qualifier(&quot;persistenceServiceForLevelReports&quot;) final GenericAppCatalogMqiService&lt;LevelReportDto&gt; persistLevelReportsService,
            @Qualifier(&quot;persistenceServiceForLevelSegments&quot;) final GenericAppCatalogMqiService&lt;LevelSegmentDto&gt; persistLevelSegmentsService,
            final OtherApplicationService otherAppService,
<span class="fc" id="L133">            final AppStatus appStatus) {</span>
<span class="fc" id="L134">        this.consumers = new HashMap&lt;&gt;();</span>
<span class="fc" id="L135">        this.appProperties = appProperties;</span>
<span class="fc" id="L136">        this.kafkaProperties = kafkaProperties;</span>
<span class="fc" id="L137">        this.otherAppService = otherAppService;</span>
<span class="fc" id="L138">        this.persistServices = new HashMap&lt;&gt;();</span>
<span class="fc" id="L139">        this.persistAuxiliaryFilesService = persistAuxiliaryFilesService;</span>
<span class="fc" id="L140">        this.persistEdrsSessionsService = persistEdrsSessionsService;</span>
<span class="fc" id="L141">        this.persistLevelJobsService = persistLevelJobsService;</span>
<span class="fc" id="L142">        this.persistLevelProductsService = persistLevelProductsService;</span>
<span class="fc" id="L143">        this.persistLevelReportsService = persistLevelReportsService;</span>
<span class="fc" id="L144">        this.persistLevelSegmentsService = persistLevelSegmentsService;</span>
<span class="fc" id="L145">        this.persistServices.put(ProductCategory.AUXILIARY_FILES,</span>
                this.persistAuxiliaryFilesService);
<span class="fc" id="L147">        this.persistServices.put(ProductCategory.EDRS_SESSIONS,</span>
                this.persistEdrsSessionsService);
<span class="fc" id="L149">        this.persistServices.put(ProductCategory.LEVEL_JOBS,</span>
                this.persistLevelJobsService);
<span class="fc" id="L151">        this.persistServices.put(ProductCategory.LEVEL_PRODUCTS,</span>
                this.persistLevelProductsService);
<span class="fc" id="L153">        this.persistServices.put(ProductCategory.LEVEL_REPORTS,</span>
                this.persistLevelReportsService);
<span class="fc" id="L155">        this.persistServices.put(ProductCategory.LEVEL_SEGMENTS,</span>
                this.persistLevelSegmentsService);
<span class="fc" id="L157">        this.appStatus = appStatus;</span>
<span class="fc" id="L158">    }</span>

    /**
     * Start consumers according the configuration
     */
    @PostConstruct
    public void startConsumers() {

        // Init the list of consumers
<span class="fc bfc" id="L167" title="All 2 branches covered.">        for (ProductCategory cat : appProperties.getProductCategories()</span>
<span class="fc" id="L168">                .keySet()) {</span>
<span class="fc" id="L169">            ProductCategoryProperties catProp =</span>
<span class="fc" id="L170">                    appProperties.getProductCategories().get(cat);</span>
<span class="fc" id="L171">            ProductCategoryConsumptionProperties prop =</span>
<span class="fc" id="L172">                    catProp.getConsumption();</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">            if (prop.isEnable()) {</span>
<span class="fc" id="L174">                LOGGER.info(</span>
                        &quot;Creating consumers on topics {} with for category {}&quot;,
<span class="fc" id="L176">                        prop.getTopicsWithPriority(), cat);</span>
<span class="fc" id="L177">                Map&lt;String, GenericConsumer&lt;?&gt;&gt; catConsumers = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">                for (String topic : prop.getTopicsWithPriority().keySet()) {</span>
<span class="pc bpc" id="L179" title="1 of 7 branches missed.">                    switch (cat) {</span>
                        case AUXILIARY_FILES:
<span class="fc" id="L181">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;AuxiliaryFileDto&gt;(
                                            kafkaProperties,
                                            persistAuxiliaryFilesService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L186">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            AuxiliaryFileDto.class));
<span class="fc" id="L188">                            break;</span>
                        case EDRS_SESSIONS:
<span class="fc" id="L190">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;EdrsSessionDto&gt;(
                                            kafkaProperties,
                                            persistEdrsSessionsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L195">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            EdrsSessionDto.class));
<span class="fc" id="L197">                            break;</span>
                        case LEVEL_JOBS:
<span class="fc" id="L199">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;LevelJobDto&gt;(
                                            kafkaProperties,
                                            persistLevelJobsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L204">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            LevelJobDto.class));
<span class="fc" id="L206">                            break;</span>
                        case LEVEL_PRODUCTS:
<span class="fc" id="L208">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;LevelProductDto&gt;(
                                            kafkaProperties,
                                            persistLevelProductsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L213">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            LevelProductDto.class));
<span class="fc" id="L215">                            break;</span>
                        case LEVEL_REPORTS:
<span class="fc" id="L217">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;LevelReportDto&gt;(
                                            kafkaProperties,
                                            persistLevelReportsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L222">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            LevelReportDto.class));
<span class="fc" id="L224">                            break;</span>
                        case LEVEL_SEGMENTS:
<span class="fc" id="L226">                            catConsumers.put(topic,</span>
                                    new GenericConsumer&lt;LevelSegmentDto&gt;(
                                            kafkaProperties,
                                            persistLevelSegmentsService,
                                            otherAppService, appStatus, topic,
<span class="fc" id="L231">                                            prop.getTopicsWithPriority().get(topic),</span>
                                            LevelSegmentDto.class));
                            break;
                    }
<span class="fc" id="L235">                }</span>
<span class="fc" id="L236">                consumers.put(cat, catConsumers);</span>
            }
<span class="fc" id="L238">        }</span>
        // Start the consumers
<span class="fc bfc" id="L240" title="All 2 branches covered.">        for (Map&lt;String, GenericConsumer&lt;?&gt;&gt; catConsumers : consumers</span>
<span class="fc" id="L241">                .values()) {</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">            for (GenericConsumer&lt;?&gt; consumer : catConsumers.values()) {</span>
<span class="fc" id="L243">                LOGGER.info(&quot;Starting consumer on topic {}&quot;,</span>
<span class="fc" id="L244">                        consumer.getTopic());</span>
<span class="fc" id="L245">                consumer.start();</span>
<span class="fc" id="L246">            }</span>
<span class="fc" id="L247">        }</span>
<span class="fc" id="L248">    }</span>

    /**
     * Get the next message for a given category
     * 
     * @param category
     * @return
     * @throws AbstractCodedException
     */
    public GenericMessageDto&lt;?&gt; nextMessage(final ProductCategory category)
            throws AbstractCodedException {
<span class="fc" id="L259">        GenericMessageDto&lt;?&gt; message = null;</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">        if (consumers.containsKey(category)) {</span>
<span class="fc bfc" id="L261" title="All 6 branches covered.">            switch (category) {</span>
                case EDRS_SESSIONS:
<span class="fc" id="L263">                    message = nextEdrsSessionsMessage();</span>
<span class="fc" id="L264">                    break;</span>
                case LEVEL_JOBS:
<span class="fc" id="L266">                    message = nextLevelJobsMessage();</span>
<span class="fc" id="L267">                    break;</span>
                case LEVEL_PRODUCTS:
<span class="fc" id="L269">                    message = nextLevelProductsMessage();</span>
<span class="fc" id="L270">                    break;</span>
                case LEVEL_REPORTS:
<span class="fc" id="L272">                    message = nextLevelReportsMessage();</span>
<span class="fc" id="L273">                    break;</span>
                case LEVEL_SEGMENTS:
<span class="fc" id="L275">                    message = nextLevelSegmentsMessage();</span>
<span class="fc" id="L276">                    break;</span>
                default:
<span class="fc" id="L278">                    message = nextAuxiliaryFilesMessage();</span>
                    break;
            }
            // if no message and consumer is pause =&gt; resume it
<span class="fc bfc" id="L282" title="All 2 branches covered.">            if (message == null) {</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">                for(GenericConsumer&lt;?&gt; consumer: consumers.get(category).values()) {</span>
<span class="fc" id="L284">                    consumer.resume();</span>
<span class="fc" id="L285">                }</span>
            }
        } else {
<span class="fc" id="L288">            throw new MqiCategoryNotAvailable(category, &quot;consumer&quot;);</span>
        }
<span class="fc" id="L290">        return message;</span>
    }

    /**
     * Get the next message for auxiliary files
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;AuxiliaryFileDto&gt; nextAuxiliaryFilesMessage()
            throws AbstractCodedException {
<span class="fc" id="L302">        List&lt;MqiGenericMessageDto&lt;AuxiliaryFileDto&gt;&gt; messages =</span>
<span class="fc" id="L303">                persistAuxiliaryFilesService.next(appProperties.getHostname());</span>
<span class="fc" id="L304">        MqiGenericMessageDto&lt;AuxiliaryFileDto&gt; result = null;</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L306">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;AuxiliaryFileDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;AuxiliaryFileDto&gt; o1,
                        MqiGenericMessageDto&lt;AuxiliaryFileDto&gt; o2) {
<span class="fc" id="L310">                    if(consumers.get(ProductCategory.AUXILIARY_FILES).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.AUXILIARY_FILES).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L312">                        return -1;</span>
<span class="fc" id="L313">                    } else if(consumers.get(ProductCategory.AUXILIARY_FILES).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.AUXILIARY_FILES).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L316">                            return 1;</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L318">                            return -1;</span>
                        } else {
<span class="fc" id="L320">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L323">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;AuxiliaryFileDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">                if (send(persistAuxiliaryFilesService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L330">                    result = tmpMessage;</span>
<span class="fc" id="L331">                    break;</span>
                }
<span class="fc" id="L333">            }</span>
        }
<span class="fc" id="L335">        return (GenericMessageDto&lt;AuxiliaryFileDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for edrs sessions
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;EdrsSessionDto&gt; nextEdrsSessionsMessage()
            throws AbstractCodedException {
<span class="fc" id="L347">        List&lt;MqiGenericMessageDto&lt;EdrsSessionDto&gt;&gt; messages =</span>
<span class="fc" id="L348">                persistEdrsSessionsService.next(appProperties.getHostname());</span>
<span class="fc" id="L349">        MqiGenericMessageDto&lt;EdrsSessionDto&gt; result = null;</span>
<span class="fc bfc" id="L350" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L351">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;EdrsSessionDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;EdrsSessionDto&gt; o1,
                        MqiGenericMessageDto&lt;EdrsSessionDto&gt; o2) {
<span class="fc" id="L355">                    if(consumers.get(ProductCategory.EDRS_SESSIONS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.EDRS_SESSIONS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L357">                        return -1;</span>
<span class="fc" id="L358">                    } else if(consumers.get(ProductCategory.EDRS_SESSIONS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.EDRS_SESSIONS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L361">                            return 1;</span>
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L363">                            return -1;</span>
                        } else {
<span class="fc" id="L365">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L368">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;EdrsSessionDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L373" title="All 2 branches covered.">                if (send(persistEdrsSessionsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L375">                    result = tmpMessage;</span>
<span class="fc" id="L376">                    break;</span>
                }
<span class="fc" id="L378">            }</span>
        }
<span class="fc" id="L380">        return (GenericMessageDto&lt;EdrsSessionDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for product jobs
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;LevelJobDto&gt; nextLevelJobsMessage()
            throws AbstractCodedException {
<span class="fc" id="L392">        List&lt;MqiGenericMessageDto&lt;LevelJobDto&gt;&gt; messages =</span>
<span class="fc" id="L393">                persistLevelJobsService.next(appProperties.getHostname());</span>
<span class="fc" id="L394">        MqiGenericMessageDto&lt;LevelJobDto&gt; result = null;</span>
<span class="fc bfc" id="L395" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L396">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;LevelJobDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;LevelJobDto&gt; o1,
                        MqiGenericMessageDto&lt;LevelJobDto&gt; o2) {
<span class="fc" id="L400">                    if(consumers.get(ProductCategory.LEVEL_JOBS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.LEVEL_JOBS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L402">                        return -1;</span>
<span class="fc" id="L403">                    } else if(consumers.get(ProductCategory.LEVEL_JOBS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.LEVEL_JOBS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L406">                            return 1;</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L408">                            return -1;</span>
                        } else {
<span class="fc" id="L410">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L413">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;LevelJobDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L418" title="All 2 branches covered.">                if (send(persistLevelJobsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L420">                    result = tmpMessage;</span>
<span class="fc" id="L421">                    break;</span>
                }
<span class="fc" id="L423">            }</span>
        }
<span class="fc" id="L425">        return (GenericMessageDto&lt;LevelJobDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for level products
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;LevelProductDto&gt; nextLevelProductsMessage()
            throws AbstractCodedException {
<span class="fc" id="L437">        List&lt;MqiGenericMessageDto&lt;LevelProductDto&gt;&gt; messages =</span>
<span class="fc" id="L438">                persistLevelProductsService.next(appProperties.getHostname());</span>
<span class="fc" id="L439">        MqiGenericMessageDto&lt;LevelProductDto&gt; result = null;</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L441">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;LevelProductDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;LevelProductDto&gt; o1,
                        MqiGenericMessageDto&lt;LevelProductDto&gt; o2) {
<span class="fc" id="L445">                    if(consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L447">                        return -1;</span>
<span class="fc" id="L448">                    } else if(consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L451">                            return 1;</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L453">                            return -1;</span>
                        } else {
<span class="fc" id="L455">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L458">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;LevelProductDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">                if (send(persistLevelProductsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L465">                    result = tmpMessage;</span>
<span class="fc" id="L466">                    break;</span>
                }
<span class="fc" id="L468">            }</span>
        }
<span class="fc" id="L470">        return (GenericMessageDto&lt;LevelProductDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for level segments
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;LevelSegmentDto&gt; nextLevelSegmentsMessage()
            throws AbstractCodedException {
<span class="fc" id="L482">        List&lt;MqiGenericMessageDto&lt;LevelSegmentDto&gt;&gt; messages =</span>
<span class="fc" id="L483">                persistLevelSegmentsService.next(appProperties.getHostname());</span>
<span class="fc" id="L484">        MqiGenericMessageDto&lt;LevelSegmentDto&gt; result = null;</span>
<span class="fc bfc" id="L485" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L486">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;LevelSegmentDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;LevelSegmentDto&gt; o1,
                        MqiGenericMessageDto&lt;LevelSegmentDto&gt; o2) {
<span class="fc" id="L490">                    if(consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L492">                        return -1;</span>
<span class="fc" id="L493">                    } else if(consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.LEVEL_PRODUCTS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L496">                            return 1;</span>
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L498">                            return -1;</span>
                        } else {
<span class="fc" id="L500">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L503">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;LevelSegmentDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">                if (send(persistLevelSegmentsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L510">                    result = tmpMessage;</span>
<span class="fc" id="L511">                    break;</span>
                }
<span class="fc" id="L513">            }</span>
        }
<span class="fc" id="L515">        return (GenericMessageDto&lt;LevelSegmentDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * Get the next message for level reports
     * 
     * @return
     * @throws AbstractCodedException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected GenericMessageDto&lt;LevelReportDto&gt; nextLevelReportsMessage()
            throws AbstractCodedException {
<span class="fc" id="L527">        List&lt;MqiGenericMessageDto&lt;LevelReportDto&gt;&gt; messages =</span>
<span class="fc" id="L528">                persistLevelReportsService.next(appProperties.getHostname());</span>
<span class="fc" id="L529">        MqiGenericMessageDto&lt;LevelReportDto&gt; result = null;</span>
<span class="fc bfc" id="L530" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(messages)) {</span>
<span class="fc" id="L531">            messages.sort(new Comparator&lt;MqiGenericMessageDto&lt;LevelReportDto&gt;&gt;() {</span>
                @Override
                public int compare(MqiGenericMessageDto&lt;LevelReportDto&gt; o1,
                        MqiGenericMessageDto&lt;LevelReportDto&gt; o2) {
<span class="fc" id="L535">                    if(consumers.get(ProductCategory.LEVEL_REPORTS).get(o1.getTopic()).getPriority() &gt;</span>
<span class="pc bpc" id="L536" title="1 of 2 branches missed.">                        consumers.get(ProductCategory.LEVEL_REPORTS).get(o2.getTopic()).getPriority()) {</span>
<span class="nc" id="L537">                        return -1;</span>
<span class="fc" id="L538">                    } else if(consumers.get(ProductCategory.LEVEL_REPORTS).get(o1.getTopic()).getPriority() ==</span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">                            consumers.get(ProductCategory.LEVEL_REPORTS).get(o2.getTopic()).getPriority()) {</span>
<span class="pc bpc" id="L540" title="1 of 2 branches missed.">                        if(o1.getCreationDate()==null) {</span>
<span class="nc" id="L541">                            return 1;</span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">                        } else if(o2.getCreationDate()==null) {</span>
<span class="nc" id="L543">                            return -1;</span>
                        } else {
<span class="fc" id="L545">                            return o1.getCreationDate().compareTo(o2.getCreationDate());</span>
                        }
                    } else {
<span class="nc" id="L548">                        return 1;</span>
                    }
                }                
            });
<span class="pc bpc" id="L552" title="1 of 2 branches missed.">            for (MqiGenericMessageDto&lt;LevelReportDto&gt; tmpMessage : messages) {</span>
<span class="fc bfc" id="L553" title="All 2 branches covered.">                if (send(persistLevelReportsService,</span>
                        (MqiLightMessageDto) tmpMessage)) {
<span class="fc" id="L555">                    result = tmpMessage;</span>
<span class="fc" id="L556">                    break;</span>
                }
<span class="fc" id="L558">            }</span>
        }
<span class="fc" id="L560">        return (GenericMessageDto&lt;LevelReportDto&gt;) convertToRestDto(result);</span>
    }

    /**
     * @param service
     * @param messageId
     * @param force
     * @return
     * @throws AbstractCodedException
     */
    protected boolean send(final GenericAppCatalogMqiService&lt;?&gt; service,
            final MqiLightMessageDto message) throws AbstractCodedException {
<span class="fc" id="L572">        boolean ret = false;</span>
<span class="fc bfc" id="L573" title="All 2 branches covered.">        if (message.getState() == MqiStateMessageEnum.SEND) {</span>
<span class="fc bfc" id="L574" title="All 2 branches covered.">            if (isSameSendingPod(message.getSendingPod())) {</span>

<span class="fc" id="L576">                ret = service.send(message.getIdentifier(),</span>
<span class="fc" id="L577">                        new MqiSendMessageDto(appProperties.getHostname(),</span>
                                false));
            } else {
<span class="fc" id="L580">                boolean isProcessing = false;</span>
                try {
<span class="fc" id="L582">                    isProcessing = otherAppService.isProcessing(</span>
<span class="fc" id="L583">                            message.getSendingPod(), service.getCategory(),</span>
<span class="fc" id="L584">                            message.getIdentifier());</span>
<span class="fc" id="L585">                } catch (AbstractCodedException ace) {</span>
<span class="fc" id="L586">                    isProcessing = false;</span>
<span class="fc" id="L587">                    LOGGER.warn(</span>
                            &quot;{} No response from the other application, consider it as dead&quot;,
<span class="fc" id="L589">                            ace.getLogMessage());</span>
<span class="fc" id="L590">                }</span>
<span class="fc bfc" id="L591" title="All 2 branches covered.">                if (!isProcessing) {</span>
<span class="fc" id="L592">                    ret = service.send(message.getIdentifier(),</span>
<span class="fc" id="L593">                            new MqiSendMessageDto(appProperties.getHostname(),</span>
                                    true));
                } else {
<span class="fc" id="L596">                    ret = false;</span>
                }
<span class="fc" id="L598">            }</span>
        } else {
            // We return this message after persisting it as sending
<span class="fc" id="L601">            ret = service.send(message.getIdentifier(),</span>
<span class="fc" id="L602">                    new MqiSendMessageDto(appProperties.getHostname(), false));</span>
        }

<span class="fc" id="L605">        return ret;</span>
    }

    /**
     * @param sendingPod
     * @return
     */
    protected boolean isSameSendingPod(final String sendingPod) {
<span class="fc" id="L613">        return appProperties.getHostname().equals(sendingPod);</span>
    }

    /**
     * Convert an app catalog rest object into mqi rest object from next API
     * 
     * @param object
     * @return
     */
    private GenericMessageDto&lt;?&gt; convertToRestDto(
            final MqiGenericMessageDto&lt;?&gt; object) {
<span class="fc bfc" id="L624" title="All 2 branches covered.">        if (object == null) {</span>
<span class="fc" id="L625">            return null;</span>
        }
<span class="fc" id="L627">        return new GenericMessageDto&lt;&gt;(object.getIdentifier(),</span>
<span class="fc" id="L628">                object.getTopic(), object.getDto());</span>
    }

    /**
     * Acknowledge a message
     * 
     * @param identifier
     * @param ack
     * @param message
     * @throws AbstractCodedException
     */
    public ResumeDetails ackMessage(final ProductCategory category,
            final long identifier, final Ack ack, final boolean stop)
            throws AbstractCodedException {
<span class="fc" id="L642">        ResumeDetails ret = null;</span>
<span class="fc" id="L643">        int nbReadingMsg = 0;</span>
<span class="fc" id="L644">        MqiGenericMessageDto&lt;?&gt; message = null;</span>
<span class="fc bfc" id="L645" title="All 2 branches covered.">        if (consumers.containsKey(category)) {</span>
            try {
                // Ack message
<span class="fc" id="L648">                persistServices.get(category).ack(identifier, ack);</span>
                // Get resume details and topic
<span class="fc" id="L650">                message = persistServices.get(category).get(identifier);</span>
                // Get remaining message read
<span class="fc" id="L652">                nbReadingMsg = persistServices.get(category)</span>
<span class="fc" id="L653">                        .getNbReadingMessages(message.getTopic(),</span>
<span class="fc" id="L654">                                appProperties.getHostname());</span>
<span class="fc" id="L655">                ret = new ResumeDetails(message.getTopic(), message.getDto());</span>
            } finally {
                // Resume consumer of concerned topic
<span class="pc bpc" id="L658" title="2 of 6 branches missed.">                if (!stop &amp;&amp; nbReadingMsg &lt;= 0 &amp;&amp; message != null) {</span>
                    // Resume consumer
<span class="fc" id="L660">                    if (consumers.get(category)</span>
<span class="fc bfc" id="L661" title="All 2 branches covered.">                            .containsKey(message.getTopic())) {</span>
<span class="fc" id="L662">                        consumers.get(category).get(message.getTopic())</span>
<span class="fc" id="L663">                                .resume();</span>
                    } else {
<span class="fc" id="L665">                        LOGGER.warn(</span>
                                &quot;[category {}] [messageCannot resume consumer for this topic because does not exist: {}&quot;,
                                category, message);
                    }
                }
            }
        } else {
<span class="fc" id="L672">            throw new MqiCategoryNotAvailable(category, &quot;consumer&quot;);</span>
        }
<span class="fc" id="L674">        return ret;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>