<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>L0SegmentAppConsumer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Spring Boot Docker For Job Generator App</a> &gt; <a href="index.source.html" class="el_package">esa.s1pdgs.cpoc.jobgenerator.tasks.l0segmentapp</a> &gt; <span class="el_source">L0SegmentAppConsumer.java</span></div><h1>L0SegmentAppConsumer.java</h1><pre class="source lang-java linenums">package esa.s1pdgs.cpoc.jobgenerator.tasks.l0segmentapp;

import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;

import esa.s1pdgs.cpoc.appcatalog.client.job.AbstractAppCatalogJobService;
import esa.s1pdgs.cpoc.appcatalog.common.rest.model.job.AppDataJobDto;
import esa.s1pdgs.cpoc.appcatalog.common.rest.model.job.AppDataJobDtoState;
import esa.s1pdgs.cpoc.appcatalog.common.rest.model.job.AppDataJobProductDto;
import esa.s1pdgs.cpoc.common.errors.AbstractCodedException;
import esa.s1pdgs.cpoc.common.errors.InvalidFormatProduct;
import esa.s1pdgs.cpoc.jobgenerator.config.L0SegmentAppProperties;
import esa.s1pdgs.cpoc.jobgenerator.config.ProcessSettings;
import esa.s1pdgs.cpoc.jobgenerator.status.AppStatus;
import esa.s1pdgs.cpoc.jobgenerator.tasks.AbstractGenericConsumer;
import esa.s1pdgs.cpoc.jobgenerator.tasks.AbstractJobsDispatcher;
import esa.s1pdgs.cpoc.mqi.client.GenericMqiService;
import esa.s1pdgs.cpoc.mqi.client.StatusService;
import esa.s1pdgs.cpoc.mqi.model.queue.LevelSegmentDto;
import esa.s1pdgs.cpoc.mqi.model.rest.GenericMessageDto;

@Component
@ConditionalOnProperty(name = &quot;process.level&quot;, havingValue = &quot;L0_SEGMENT&quot;)

public class L0SegmentAppConsumer
        extends AbstractGenericConsumer&lt;LevelSegmentDto&gt; {

    /**
     * Pattern built from the regular expression given in configuration
     */
    private final Pattern pattern;
    private final Map&lt;String, Integer&gt; patternGroups;

    /**
     * Constructor
     * 
     * @param jobsDispatcher
     * @param patternSettings
     * @param processSettings
     * @param mqiService
     * @param appDataService
     * @param appStatus
     */
    @Autowired
    public L0SegmentAppConsumer(
            final AbstractJobsDispatcher&lt;LevelSegmentDto&gt; jobsDispatcher,
            final L0SegmentAppProperties appProperties,
            final ProcessSettings processSettings,
            @Qualifier(&quot;mqiServiceForLevelSegments&quot;) final GenericMqiService&lt;LevelSegmentDto&gt; mqiService,
            @Qualifier(&quot;mqiServiceForStatus&quot;) final StatusService mqiStatusService,
            @Qualifier(&quot;appCatalogServiceForLevelSegments&quot;) final AbstractAppCatalogJobService&lt;LevelSegmentDto&gt; appDataService,
            final AppStatus appStatus) {
<span class="fc" id="L62">        super(jobsDispatcher, processSettings, mqiService, mqiStatusService,</span>
                appDataService, appStatus);
<span class="fc" id="L64">        this.pattern = Pattern.compile(appProperties.getNameRegexpPattern(),</span>
                Pattern.CASE_INSENSITIVE);
<span class="fc" id="L66">        this.patternGroups = appProperties.getNameRegexpGroups();</span>
<span class="fc" id="L67">    }</span>

    /**
     * Periodic function for processing messages
     */
    @Scheduled(fixedDelayString = &quot;${process.fixed-delay-ms}&quot;, initialDelayString = &quot;${process.initial-delay-ms}&quot;)
    public void consumeMessages() {
        // First, consume message
<span class="fc" id="L75">        GenericMessageDto&lt;LevelSegmentDto&gt; mqiMessage = readMessage();</span>
<span class="pc bpc" id="L76" title="1 of 4 branches missed.">        if (mqiMessage == null || mqiMessage.getBody() == null) {</span>
<span class="fc" id="L77">            LOGGER.trace(&quot;[MONITOR] [step 0] No message received: continue&quot;);</span>
<span class="fc" id="L78">            return;</span>
        }
        // process message
<span class="fc" id="L81">        appStatus.setProcessing(mqiMessage.getIdentifier());</span>
<span class="fc" id="L82">        int step = 1;</span>
<span class="fc" id="L83">        boolean ackOk = false;</span>
<span class="fc" id="L84">        String errorMessage = &quot;&quot;;</span>
<span class="fc" id="L85">        String productName = mqiMessage.getBody().getName();</span>
        // Note: the report log of consume and global log is raised during
        // building job to get the datatake identifier which is the real
        // product name

        try {

            // Check if a job is already created for message identifier
<span class="fc" id="L93">            LOGGER.info(</span>
                    &quot;[MONITOR] [step 1] [productName {}] Creating/updating job&quot;,
                    productName);
<span class="fc" id="L96">            AppDataJobDto&lt;LevelSegmentDto&gt; appDataJob = buildJob(mqiMessage);</span>
<span class="fc" id="L97">            productName = appDataJob.getProduct().getProductName();</span>

            // Dispatch job
<span class="fc" id="L100">            step++;</span>
<span class="fc" id="L101">            LOGGER.info(</span>
                    &quot;[MONITOR] [step 2] [productName {}] Dispatching product&quot;,
                    productName);
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            if (appDataJob.getState() == AppDataJobDtoState.WAITING</span>
                    || appDataJob
<span class="nc bnc" id="L106" title="All 2 branches missed.">                            .getState() == AppDataJobDtoState.DISPATCHING) {</span>
<span class="fc" id="L107">                appDataJob.setState(AppDataJobDtoState.DISPATCHING);</span>
<span class="fc" id="L108">                appDataJob = appDataService.patchJob(appDataJob.getIdentifier(),</span>
                        appDataJob, false, false, false);
<span class="fc" id="L110">                jobsDispatcher.dispatch(appDataJob);</span>
            } else {
<span class="nc" id="L112">                LOGGER.info(</span>
                        &quot;[MONITOR] [step 2] [productName {}] Job for datatake already dispatched&quot;,
                        productName);
            }

            // Ack
<span class="fc" id="L118">            step++;</span>
<span class="fc" id="L119">            ackOk = true;</span>

<span class="nc" id="L121">        } catch (AbstractCodedException ace) {</span>
<span class="nc" id="L122">            ackOk = false;</span>
<span class="nc" id="L123">            errorMessage = String.format(</span>
<span class="nc" id="L124">                    &quot;[MONITOR] [step %d] [productName %s] [code %d] %s&quot;, step,</span>
<span class="nc" id="L125">                    productName, ace.getCode().getCode(),</span>
<span class="nc" id="L126">                    ace.getLogMessage());</span>
<span class="fc" id="L127">        }</span>

        // Ack and check if application shall stopped
<span class="fc" id="L130">        ackProcessing(mqiMessage, ackOk, productName, errorMessage);</span>

<span class="fc" id="L132">        LOGGER.info(&quot;[MONITOR] [step 0] [productName {}] End&quot;,</span>
                productName);
<span class="fc" id="L134">    }</span>

    protected AppDataJobDto&lt;LevelSegmentDto&gt; buildJob(
            GenericMessageDto&lt;LevelSegmentDto&gt; mqiMessage)
            throws AbstractCodedException {
<span class="fc" id="L139">        LevelSegmentDto leveldto = mqiMessage.getBody();</span>

        // Check if a job is already created for message identifier
<span class="fc" id="L142">        List&lt;AppDataJobDto&lt;LevelSegmentDto&gt;&gt; existingJobs = appDataService</span>
<span class="fc" id="L143">                .findByMessagesIdentifier(mqiMessage.getIdentifier());</span>

<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (CollectionUtils.isEmpty(existingJobs)) {</span>

            // Extract information from name
<span class="fc" id="L148">            Matcher m = pattern.matcher(leveldto.getName());</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            if (!m.matches()) {</span>
<span class="nc" id="L150">                throw new InvalidFormatProduct(</span>
                        &quot;Don't match with regular expression &quot;
<span class="nc" id="L152">                                + this.pattern.pattern());</span>
            }
<span class="fc" id="L154">            String satelliteId = m.group(this.patternGroups.get(&quot;satelliteId&quot;));</span>
<span class="fc" id="L155">            String missionId = m.group(this.patternGroups.get(&quot;missionId&quot;));</span>
<span class="fc" id="L156">            String acquisition = m.group(this.patternGroups.get(&quot;acquisition&quot;));</span>
<span class="fc" id="L157">            String datatakeID = m.group(this.patternGroups.get(&quot;datatakeId&quot;));</span>

            // Search job for given datatake id
<span class="fc" id="L160">            List&lt;AppDataJobDto&lt;LevelSegmentDto&gt;&gt; existingJobsForDatatake =</span>
<span class="fc" id="L161">                    appDataService.findByProductDataTakeId(datatakeID);</span>

<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (CollectionUtils.isEmpty(existingJobsForDatatake)) {</span>

                // Create the JOB
<span class="fc" id="L166">                AppDataJobDto&lt;LevelSegmentDto&gt; jobDto = new AppDataJobDto&lt;&gt;();</span>
                // General details
<span class="fc" id="L168">                jobDto.setLevel(processSettings.getLevel());</span>
<span class="fc" id="L169">                jobDto.setPod(processSettings.getHostname());</span>
                // Messages
<span class="fc" id="L171">                jobDto.getMessages().add(mqiMessage);</span>
                // Product
<span class="fc" id="L173">                AppDataJobProductDto productDto = new AppDataJobProductDto();</span>
<span class="fc" id="L174">                productDto.setAcquisition(acquisition);</span>
<span class="fc" id="L175">                productDto.setMissionId(missionId);</span>
<span class="fc" id="L176">                productDto.setDataTakeId(datatakeID);</span>
<span class="fc" id="L177">                productDto.setProductName(&quot;l0_segments_for_&quot; + datatakeID);</span>
<span class="fc" id="L178">                productDto.setProcessMode(leveldto.getMode());</span>
<span class="fc" id="L179">                productDto.setSatelliteId(satelliteId);</span>
<span class="fc" id="L180">                jobDto.setProduct(productDto);</span>

<span class="fc" id="L182">                LOGGER.info(</span>
                        &quot;[REPORT] [MONITOR] [s1pdgsTask L0_SEGMENTJobGeneration] [START] [productName {}] Starting job generation&quot;,
<span class="fc" id="L184">                        productDto.getProductName());</span>
<span class="fc" id="L185">                LOGGER.info(</span>
                        &quot;[REPORT] [MONITOR] [step 0] [s1pdgsTask L0_SEGMENTJobGeneration] [subTask Consume] [START] [productName {}] [inputs {}] Starting job generation&quot;,
<span class="fc" id="L187">                        productDto.getProductName(), leveldto.getName());</span>

<span class="fc" id="L189">                return appDataService.newJob(jobDto);</span>
            } else {
<span class="nc" id="L191">                AppDataJobDto&lt;LevelSegmentDto&gt; jobDto =</span>
<span class="nc" id="L192">                        existingJobsForDatatake.get(0);</span>
<span class="nc" id="L193">                LOGGER.info(</span>
                        &quot;[REPORT] [MONITOR] [step 0] [s1pdgsTask L0_SEGMENTJobGeneration] [subTask Consume] [START] [productName {}] [inputs {}] Starting job generation&quot;,
<span class="nc" id="L195">                        jobDto.getProduct().getProductName(), leveldto.getName());</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                if (!jobDto.getPod().equals(processSettings.getHostname())) {</span>
<span class="nc" id="L197">                    jobDto.setPod(processSettings.getHostname());</span>
                }
<span class="nc" id="L199">                jobDto.getMessages().add(mqiMessage);</span>
<span class="nc" id="L200">                return appDataService.patchJob(jobDto.getIdentifier(), jobDto,</span>
                        true, false, false);

            }

        } else {
            // Update pod if needed
<span class="nc" id="L207">            AppDataJobDto&lt;LevelSegmentDto&gt; jobDto = existingJobs.get(0);</span>
<span class="nc" id="L208">            LOGGER.info(</span>
                    &quot;[REPORT] [MONITOR] [step 0] [s1pdgsTask L0_SEGMENTJobGeneration] [subTask Consume] [START] [productName {}] [inputs {}] Starting job generation&quot;,
<span class="nc" id="L210">                    jobDto.getProduct().getProductName(), leveldto.getName());</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (!jobDto.getPod().equals(processSettings.getHostname())) {</span>
<span class="nc" id="L212">                jobDto.setPod(processSettings.getHostname());</span>
<span class="nc" id="L213">                jobDto = appDataService.patchJob(jobDto.getIdentifier(), jobDto,</span>
                        false, false, false);
            }
            // Job already exists
<span class="nc" id="L217">            return jobDto;</span>
        }
    }

    @Override
    protected String getTaskForFunctionalLog() {
<span class="fc" id="L223">        return &quot;L0_SEGMENTJobGeneration&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>