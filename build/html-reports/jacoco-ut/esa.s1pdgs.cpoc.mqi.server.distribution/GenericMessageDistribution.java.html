<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GenericMessageDistribution.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">S1-PDGS Cloud POC - Message queue interface server</a> &gt; <a href="index.source.html" class="el_package">esa.s1pdgs.cpoc.mqi.server.distribution</a> &gt; <span class="el_source">GenericMessageDistribution.java</span></div><h1>GenericMessageDistribution.java</h1><pre class="source lang-java linenums">package esa.s1pdgs.cpoc.mqi.server.distribution;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

import esa.s1pdgs.cpoc.common.ProductCategory;
import esa.s1pdgs.cpoc.common.ResumeDetails;
import esa.s1pdgs.cpoc.common.errors.AbstractCodedException;
import esa.s1pdgs.cpoc.common.errors.mqi.MqiCategoryNotAvailable;
import esa.s1pdgs.cpoc.common.errors.mqi.MqiPublicationError;
import esa.s1pdgs.cpoc.common.errors.mqi.MqiRouteNotAvailable;
import esa.s1pdgs.cpoc.mqi.model.rest.Ack;
import esa.s1pdgs.cpoc.mqi.model.rest.GenericMessageDto;
import esa.s1pdgs.cpoc.mqi.model.rest.GenericPublicationMessageDto;
import esa.s1pdgs.cpoc.mqi.server.ApplicationProperties;
import esa.s1pdgs.cpoc.mqi.server.consumption.MessageConsumptionController;
import esa.s1pdgs.cpoc.mqi.server.publication.MessagePublicationController;

/**
 * Generic message distribution
 * 
 * @author Viveris Technologies
 * @param &lt;T&gt;
 *            product category
 */
public class GenericMessageDistribution&lt;T&gt; {

    /**
     * Logger
     */
<span class="fc" id="L33">    private static final Logger LOGGER =</span>
<span class="fc" id="L34">            LogManager.getLogger(GenericMessageDistribution.class);</span>

    /**
     * Message consumption controller
     */
    protected final MessageConsumptionController messages;

    /**
     * Message publication controller
     */
    protected final MessagePublicationController publication;

    /**
     * Application properties
     */
    protected final ApplicationProperties properties;

    /**
     * Product category
     */
    protected final ProductCategory category;

    /**
     * Constructor
     * 
     * @param messages
     */
    public GenericMessageDistribution(
            final MessageConsumptionController messages,
            final MessagePublicationController publication,
            final ApplicationProperties properties,
<span class="fc" id="L65">            final ProductCategory category) {</span>
<span class="fc" id="L66">        LOGGER.info(&quot;Starting REST API for {}&quot;, category);</span>
<span class="fc" id="L67">        this.messages = messages;</span>
<span class="fc" id="L68">        this.publication = publication;</span>
<span class="fc" id="L69">        this.properties = properties;</span>
<span class="fc" id="L70">        this.category = category;</span>
<span class="fc" id="L71">    }</span>

    /**
     * Get the next message to proceed
     * 
     * @return
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    protected ResponseEntity&lt;GenericMessageDto&lt;T&gt;&gt; next() {
<span class="fc" id="L80">        LOGGER.debug(&quot;[MONITOR] [category {}] [api next] Starting&quot;, category);</span>

        // We wait to be sure one message is read
        try {
<span class="fc" id="L84">            Thread.sleep(properties.getWaitNextMs());</span>
<span class="nc" id="L85">        } catch (InterruptedException iee) {</span>
<span class="nc" id="L86">            LOGGER.debug(</span>
                    &quot;[MONITOR] [category {}] [api next] Interrupted exception during waiting&quot;,
                    category);
<span class="fc" id="L89">        }</span>

<span class="fc" id="L91">        ResponseEntity&lt;GenericMessageDto&lt;T&gt;&gt; result =</span>
                new ResponseEntity&lt;GenericMessageDto&lt;T&gt;&gt;(
                        HttpStatus.INTERNAL_SERVER_ERROR);
        try {
<span class="fc" id="L95">            result = new ResponseEntity&lt;GenericMessageDto&lt;T&gt;&gt;(</span>
<span class="fc" id="L96">                    (GenericMessageDto&lt;T&gt;) messages.nextMessage(category),</span>
                    HttpStatus.OK);
<span class="fc" id="L98">        } catch (AbstractCodedException mcna) {</span>
<span class="fc" id="L99">            LOGGER.error(</span>
                    &quot;[MONITOR] [category {}] [api next] [code {}] [error {}]&quot;,
<span class="fc" id="L101">                    category, mcna.getCode().getCode(), mcna.getLogMessage());</span>
<span class="fc" id="L102">            result = new ResponseEntity&lt;GenericMessageDto&lt;T&gt;&gt;(</span>
                    HttpStatus.INTERNAL_SERVER_ERROR);
<span class="fc" id="L104">        }</span>
<span class="fc" id="L105">        LOGGER.debug(&quot;[MONITOR] [category {}] [api next] [httpCode {}] End&quot;,</span>
<span class="fc" id="L106">                category, result.getStatusCodeValue());</span>
<span class="fc" id="L107">        return result;</span>
    }

    /**
     * Acknowledge the message
     * 
     * @param messageId
     * @return
     */
    protected ResponseEntity&lt;Boolean&gt; ack(final long identifier, final Ack ack,
            final String message, boolean stop) {
<span class="fc" id="L118">        LOGGER.info(&quot;[MONITOR] [category {}] [api ack] [messageId {}] Starting&quot;,</span>
<span class="fc" id="L119">                category, identifier);</span>

        // Ack message if OK
<span class="fc" id="L122">        ResponseEntity&lt;Boolean&gt; result =</span>
                new ResponseEntity&lt;Boolean&gt;(HttpStatus.INTERNAL_SERVER_ERROR);
<span class="fc" id="L124">        ResumeDetails resumeDetails = null;</span>
        try {
<span class="fc" id="L126">            resumeDetails =</span>
<span class="fc" id="L127">                    messages.ackMessage(category, identifier, ack, stop);</span>
<span class="fc" id="L128">            result = new ResponseEntity&lt;Boolean&gt;(true, HttpStatus.OK);</span>
<span class="fc" id="L129">        } catch (AbstractCodedException mcna) {</span>
<span class="fc" id="L130">            LOGGER.error(</span>
                    &quot;[MONITOR] [category {}] [api ack] [messageId {}] [code {}] [error {}]&quot;,
<span class="fc" id="L132">                    category, identifier, mcna.getCode().getCode(),</span>
<span class="fc" id="L133">                    mcna.getLogMessage());</span>
<span class="fc" id="L134">            result = new ResponseEntity&lt;Boolean&gt;(</span>
                    HttpStatus.INTERNAL_SERVER_ERROR);
<span class="fc" id="L136">        }</span>

        // If error, log in KAFKA topic the message
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (ack == Ack.ERROR) {</span>
<span class="fc" id="L140">            String logMessage = message;</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">            if (resumeDetails != null) {</span>
<span class="fc" id="L142">                logMessage = message</span>
<span class="fc" id="L143">                        + String.format(&quot; [resumeDetails %s]&quot;, resumeDetails);</span>
            }
<span class="fc" id="L145">            publication.publishError(logMessage);</span>
        }

<span class="fc" id="L148">        LOGGER.info(</span>
                &quot;[MONITOR] [category {}] [api ack] [messageId {}] [httpCode {}] End&quot;,
<span class="fc" id="L150">                category, identifier, result.getStatusCodeValue());</span>
<span class="fc" id="L151">        return result;</span>
    }

    /**
     * Publish a message
     * 
     * @param inputMessageId
     * @param inputKey
     * @param outputKey
     * @param family
     * @param ouputMessage
     * @return
     */
    protected ResponseEntity&lt;Void&gt; publish(final String logMessage,
            final GenericPublicationMessageDto&lt;T&gt; message) {

<span class="fc" id="L167">        LOGGER.info(</span>
                &quot;[MONITOR] [category {}] [api publish] [messageId {}] {} Starting&quot;,
<span class="fc" id="L169">                category, message.getInputMessageId(), logMessage);</span>

<span class="fc" id="L171">        ResponseEntity&lt;Void&gt; result =</span>
                new ResponseEntity&lt;Void&gt;(HttpStatus.NOT_FOUND);
        try {
<span class="fc" id="L174">            publication.publish(category, message.getMessageToPublish());</span>
<span class="fc" id="L175">            result = new ResponseEntity&lt;Void&gt;(HttpStatus.OK);</span>
<span class="fc" id="L176">        } catch (MqiPublicationError kse) {</span>
<span class="fc" id="L177">            LOGGER.error(&quot;[publish] KafkaSendException occurred: {}&quot;,</span>
<span class="fc" id="L178">                    kse.getMessage());</span>
<span class="fc" id="L179">            result = new ResponseEntity&lt;Void&gt;(HttpStatus.GATEWAY_TIMEOUT);</span>
<span class="fc" id="L180">        } catch (MqiCategoryNotAvailable | MqiRouteNotAvailable mcna) {</span>
<span class="fc" id="L181">            LOGGER.error(</span>
                    &quot;[MONITOR] [category {}] [api publish] {} [code {}] [error {}]&quot;,
<span class="fc" id="L183">                    category, logMessage, mcna.getCode().getCode(),</span>
<span class="fc" id="L184">                    mcna.getLogMessage());</span>
<span class="fc" id="L185">            result = new ResponseEntity&lt;Void&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L186">        }</span>

<span class="fc" id="L188">        LOGGER.info(</span>
                &quot;[MONITOR] [category {}] [api publish] [httpCode {}] [messageId {}] {} End&quot;,
<span class="fc" id="L190">                category, result.getStatusCodeValue(),</span>
<span class="fc" id="L191">                message.getInputMessageId(), logMessage);</span>

<span class="fc" id="L193">        return result;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>