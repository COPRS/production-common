<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LocalDirectoryCleaning.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">S1-PDGS Cloud POC ingestor</a> &gt; <a href="index.source.html" class="el_package">esa.s1pdgs.cpoc.ingestor.files</a> &gt; <span class="el_source">LocalDirectoryCleaning.java</span></div><h1>LocalDirectoryCleaning.java</h1><pre class="source lang-java linenums">package esa.s1pdgs.cpoc.ingestor.files;

import java.io.File;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

/**
 * Clean empty directories (since too long) of auxiliary and EDRS session FTP
 * directories
 * 
 * @author Cyrielle
 */
@Component
public class LocalDirectoryCleaning {

<span class="fc" id="L21">    private static final Logger LOGGER =</span>
<span class="fc" id="L22">            LogManager.getLogger(LocalDirectoryCleaning.class);</span>

    /**
     * Used directory for EDRS sessions
     */
    private final String sessionDir;

    /**
     * if file.lastmodified &lt;= curretn milliseconds - min age AND dir is empty
     * =&gt; we can delete it
     */
    private final long sessionMinAge;

    /**
     * Used directory for auxiliary files
     */
    private final String auxiliaryDir;

    /**
     * if file.lastmodified &lt;= curretn milliseconds - min age AND dir is empty
     * =&gt; we can delete it
     */
    private final long configMinAge;

    /**
     * Constructor
     * 
     * @param sessionLocalDirectory
     * @param sessionMinAge
     * @param configLocalDirectory
     * @param configMinAge
     */
    @Autowired
    public LocalDirectoryCleaning(
            @Value(&quot;${file.session-files.local-directory}&quot;) final String sessionDir,
            @Value(&quot;${file.session-files.clean-empty-min-age}&quot;) final long sessionMinAge,
            @Value(&quot;${file.auxiliary-files.local-directory}&quot;) final String auxiliaryDir,
<span class="fc" id="L59">            @Value(&quot;${file.auxiliary-files.clean-empty-min-age}&quot;) final long configMinAge) {</span>
<span class="fc" id="L60">        this.sessionDir = sessionDir;</span>
<span class="fc" id="L61">        this.auxiliaryDir = auxiliaryDir;</span>
<span class="fc" id="L62">        this.configMinAge = configMinAge;</span>
<span class="fc" id="L63">        this.sessionMinAge = sessionMinAge;</span>
<span class="fc" id="L64">    }</span>

    /**
     * Periodically clean the auxiliary files directory
     */
    @Scheduled(fixedDelayString = &quot;${file.auxiliary-files.clean-empty-directory-rate}&quot;)
    public void cleanAuxiliaryFilesDirectory() {
<span class="fc" id="L71">        this.cleanDirectory(auxiliaryDir, configMinAge);</span>
<span class="fc" id="L72">    }</span>

    /**
     * Periodically clean the EDRS session directory
     */
    @Scheduled(fixedDelayString = &quot;${file.session-files.clean-empty-directory-rate}&quot;)
    public void cleanSessionFilesDirectory() {
<span class="fc" id="L79">        this.cleanDirectory(sessionDir, sessionMinAge);</span>
<span class="fc" id="L80">    }</span>

    /**
     * If possible, clean a directory or its su-directories when they have not
     * been modified since minAge
     * 
     * @param directory
     * @param minAge
     */
    protected void cleanDirectory(final String directory, final long minAge) {
        try {
<span class="fc" id="L91">            long lastModifiedMin = System.currentTimeMillis() - minAge;</span>
<span class="fc" id="L92">            File file = new File(directory);</span>
<span class="fc" id="L93">            File[] files = file.listFiles();</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            if (files != null) {</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">                for (File child : files) {</span>
<span class="fc" id="L96">                    this.recursiveEmptyDirectoriesDeletion(child,</span>
                            lastModifiedMin);
                }
            }
<span class="nc" id="L100">        } catch (SecurityException e) {</span>
<span class="nc" id="L101">            LOGGER.error(&quot;[code {}] [directory {}] [age {}] [msg {}]&quot;, 202,</span>
<span class="nc" id="L102">                    directory, minAge, e.getMessage());</span>
<span class="fc" id="L103">        }</span>
<span class="fc" id="L104">    }</span>

    /**
     * Recursively remove a directory and its sub-directories if they have not
     * been modified since min age
     * 
     * @param file
     * @param lastModifiedMin
     * @return
     * @throws SecurityException
     */
    protected long recursiveEmptyDirectoriesDeletion(final File file,
            final long lastModifiedMin) throws SecurityException {
<span class="fc" id="L117">        long nbFiles = 0;</span>
<span class="pc bpc" id="L118" title="2 of 4 branches missed.">        if (file != null &amp;&amp; file.isDirectory()) {</span>
<span class="fc" id="L119">            File[] files = file.listFiles();</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if (files != null) {</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">                for (File child : files) {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                    if (child.isDirectory()) {</span>
<span class="fc" id="L123">                        nbFiles += recursiveEmptyDirectoriesDeletion(child,</span>
                                lastModifiedMin);
                    } else {
<span class="fc" id="L126">                        nbFiles += 1;</span>
                    }
                }
            }
<span class="fc bfc" id="L130" title="All 4 branches covered.">            if (nbFiles == 0 &amp;&amp; file.lastModified() &lt;= lastModifiedMin) {</span>
<span class="fc" id="L131">                file.delete();</span>
            }
        }

<span class="fc" id="L135">        return nbFiles;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>